{% extends "base.html" %}
{% block content %}
<!-- ä¸»è®¾ç½®åŒºåŸŸ -->
<div class="row">
    <!-- æ‰“å¡é…ç½® -->
    <div class="col-md-6 mb-4">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white fw-bold text-primary py-3">æ‰“å¡é…ç½®</div>
            <div class="card-body">
                <div class="form-check form-switch mb-3 p-2 bg-light rounded">
                    <input class="form-check-input ms-0 me-2" type="checkbox" id="checkin_open" {{ 'checked' if sys.checkin_open }}>
                    <label class="fw-bold">å¼€å¯æ‰“å¡åŠŸèƒ½</label>
                </div>
                <div class="mb-3">
                    <label class="small text-muted">æ‰“å¡æŒ‡ä»¤</label>
                    <input id="checkin_cmd" class="form-control" value="{{ sys.checkin_cmd }}">
                </div>
                
                <label class="small text-muted fw-bold mb-2">æç¤ºæ¶ˆæ¯æ–‡æ¡ˆ</label>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-light border text-start" onclick="openEditor('msg_checkin_success','æ‰“å¡æˆåŠŸæ¶ˆæ¯')">
                        âœ… æ‰“å¡æˆåŠŸæ¶ˆæ¯ <i class="fa-solid fa-pen float-end mt-1 text-muted"></i>
                    </button>
                    <button class="btn btn-light border text-start" onclick="openEditor('msg_not_registered','æœªè®¤è¯æç¤º')">
                        âš ï¸ æœªè®¤è¯æç¤º <i class="fa-solid fa-pen float-end mt-1 text-muted"></i>
                    </button>
                    <button class="btn btn-light border text-start" onclick="openEditor('msg_repeat_checkin','é‡å¤æ‰“å¡æç¤º')">
                        ğŸ”„ é‡å¤æ‰“å¡æç¤º <i class="fa-solid fa-pen float-end mt-1 text-muted"></i>
                    </button>
                </div>
                <div class="row g-2 align-items-center mt-4">
                    <div class="col-8"><label class="small text-muted">æŒ‡ä»¤è‡ªåŠ¨åˆ é™¤æ—¶é—´(ç§’)</label></div>
                    <div class="col-4"><input type="number" id="checkin_del_time" class="form-control form-control-sm" value="{{ sys.checkin_del_time }}"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŸ¥è¯¢é…ç½® -->
    <div class="col-md-6 mb-4">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white fw-bold text-success py-3">æŸ¥è¯¢é…ç½®</div>
            <div class="card-body">
                <div class="form-check form-switch mb-3 p-2 bg-light rounded">
                    <input class="form-check-input ms-0 me-2" type="checkbox" id="query_open" {{ 'checked' if sys.query_open }}>
                    <label class="fw-bold">å¼€å¯æŸ¥è¯¢åŠŸèƒ½</label>
                </div>
                <div class="mb-3">
                    <label class="small text-muted">æŸ¥è¯¢æŒ‡ä»¤</label>
                    <input id="query_cmd" class="form-control" value="{{ sys.query_cmd }}">
                </div>

                <label class="small text-muted fw-bold mb-2">æ˜¾ç¤ºæ¨¡æ¿</label>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-light border text-start" onclick="openEditor('msg_query_header','åˆ—è¡¨æŠ¬å¤´å†…å®¹')">
                        ğŸ“ åˆ—è¡¨æŠ¬å¤´å†…å®¹ <i class="fa-solid fa-pen float-end mt-1 text-muted"></i>
                    </button>
                    <button class="btn btn-light border text-start" onclick="openEditor('template','å•ç”¨æˆ·å±•ç¤ºæ¨¡æ¿')">
                        ğŸ‘¤ å•ç”¨æˆ·å±•ç¤ºæ¨¡æ¿ <i class="fa-solid fa-pen float-end mt-1 text-muted"></i>
                    </button>
                </div>
                
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small text-muted">åœ¨çº¿è¡¨æƒ…</label><input id="online_emoji" class="form-control text-center" value="{{ sys.online_emoji }}"></div>
                    <div class="col-6"><label class="small text-muted">ç¦»çº¿è¡¨æƒ…</label><input id="offline_emoji" class="form-control text-center" value="{{ sys.offline_emoji }}"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="fixed-bottom bg-white border-top p-3 shadow" style="left: 260px;">
    <button class="btn btn-primary w-100 fw-bold" onclick="saveAll()">ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
</div>

<!-- ä»¿æˆªå›¾é£æ ¼çš„ç¼–è¾‘å™¨ Modal -->
<div class="modal fade" id="editorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title fw-bold">ç¼–è¾‘æ–‡æœ¬</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <!-- å˜é‡åŒº (ä»¿æˆªå›¾é£æ ¼) -->
                <div class="p-3 border-bottom bg-light">
                    <div class="d-flex flex-wrap gap-3" style="font-size: 14px;">
                        <span class="text-muted fw-bold">æ’å…¥å˜é‡:</span>
                        <span class="cursor-pointer text-dark hover-blue" onclick="insert('{onlineEmoji}')">åœ¨çº¿è¡¨æƒ…</span>
                        {% for f in fields %}
                        <span class="cursor-pointer text-dark hover-blue" onclick="insert('{'+'{{ f.label }}'+'}')">{{ f.label }}</span>
                        {% endfor %}
                    </div>
                </div>
                <!-- å·¥å…·æ  -->
                <div class="px-3 py-2 border-bottom d-flex gap-2">
                    <button class="btn btn-sm btn-light" onclick="cmd('bold')"><i class="fa-solid fa-bold"></i></button>
                    <button class="btn btn-sm btn-light" onclick="cmd('italic')"><i class="fa-solid fa-italic"></i></button>
                    <button class="btn btn-sm btn-light" onclick="cmd('underline')"><i class="fa-solid fa-underline"></i></button>
                    <div class="vr"></div>
                    <button class="btn btn-sm btn-light" onclick="link()"><i class="fa-solid fa-link"></i></button>
                    <button class="btn btn-sm btn-light" onclick="cmd('removeFormat')"><i class="fa-solid fa-eraser"></i></button>
                </div>
                <!-- ç¼–è¾‘åŒº -->
                <div id="richEditor" class="p-3" contenteditable="true" style="min-height: 200px; outline: none; font-size: 15px; line-height: 1.6;"></div>
            </div>
            <div class="modal-footer py-2">
                <button class="btn btn-primary px-4" onclick="saveEd()">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<!-- éšè—åŸŸ -->
<div style="display:none">
    <textarea id="v_msg_checkin_success">{{ sys.msg_checkin_success }}</textarea>
    <textarea id="v_msg_not_registered">{{ sys.msg_not_registered }}</textarea>
    <textarea id="v_msg_repeat_checkin">{{ sys.msg_repeat_checkin }}</textarea>
    <textarea id="v_msg_query_header">{{ sys.msg_query_header }}</textarea>
    <textarea id="v_template">{{ sys.template }}</textarea>
</div>

<script>
    let cur='', modal=null;
    document.addEventListener('DOMContentLoaded', ()=> modal = new bootstrap.Modal(document.getElementById('editorModal')));
    
    function openEditor(k,t){ 
        cur=k; 
        document.querySelector('.modal-title').innerText=t; 
        document.getElementById('richEditor').innerHTML=document.getElementById('v_'+k).value; 
        modal.show(); 
    }
    
    function saveEd(){ document.getElementById('v_'+cur).value=document.getElementById('richEditor').innerHTML; modal.hide(); }
    function cmd(c,v=null){ document.getElementById('richEditor').focus(); document.execCommand(c,false,v); }
    function insert(t){ cmd('insertText', t); } // ç›´æ¥æ’å…¥å˜é‡å
    function link(){ let u=prompt('é“¾æ¥:'); if(u) cmd('createLink',u); }
    
    function saveAll(){
        const d = {
            checkin_open: document.getElementById('checkin_open').checked, 
            checkin_cmd: document.getElementById('checkin_cmd').value,
            checkin_del_time: document.getElementById('checkin_del_time').value,
            
            query_open: document.getElementById('query_open').checked, 
            query_cmd: document.getElementById('query_cmd').value,
            
            msg_checkin_success: document.getElementById('v_msg_checkin_success').value, 
            msg_not_registered: document.getElementById('v_msg_not_registered').value,
            msg_repeat_checkin: document.getElementById('v_msg_repeat_checkin').value, 
            msg_query_header: document.getElementById('v_msg_query_header').value, 
            template: document.getElementById('v_template').value,
            
            online_emoji: document.getElementById('online_emoji').value, 
            offline_emoji: document.getElementById('offline_emoji').value,
            auto_like: true, like_emoji: "â¤ï¸", // é»˜è®¤å¼€å¯
            push_channel_id: "{{ sys.push_channel_id }}" 
        };
        fetch('/core/api/save_system', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)})
        .then(()=>alert('âœ… ä¿å­˜æˆåŠŸ'));
    }
</script>
<style>
    .hover-blue:hover { color: #0d6efd !important; text-decoration: underline; }
    @media (max-width: 768px) { .fixed-bottom { left: 0 !important; } }
</style>
{% endblock %}
