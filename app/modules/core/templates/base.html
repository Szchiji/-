<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #4e73df; --bg-color: #f8f9fc; }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', Roboto, sans-serif; color: #5a5c69; }
        
        /* 侧边栏 */
        .sidebar { width: 250px; background: white; position: fixed; top: 0; left: 0; height: 100vh; border-right: 1px solid #e3e6f0; z-index: 1000; overflow-y: auto; }
        .sidebar-brand { height: 70px; display: flex; align-items: center; padding: 0 1.5rem; font-weight: 800; font-size: 1.2rem; color: #4e73df; border-bottom: 1px solid #e3e6f0; text-decoration: none; }
        .nav-link { color: #5a5c69; padding: 1rem 1.5rem; font-weight: 600; display: flex; align-items: center; text-decoration: none; transition: 0.2s; }
        .nav-link:hover { background: #f8f9fc; color: #4e73df; }
        .nav-link.active { color: #4e73df; background: #f0f4ff; border-right: 4px solid #4e73df; }
        .nav-link i { width: 24px; margin-right: 8px; text-align: center; }
        
        /* 主内容 */
        .main-wrapper { min-height: 100vh; display: flex; flex-direction: column; transition: margin-left 0.2s; }
        .topbar { height: 70px; background: white; border-bottom: 1px solid #e3e6f0; display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; }
        .content { padding: 2rem; }
        
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-wrapper { margin-left: 0 !important; }
        }
    </style>
    {% block head %}{% endblock %}
</head>
<body>
    <!-- 气泡提示 -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
      <div id="liveToast" class="toast align-items-center border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body fw-bold" id="toastMessage"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>

    <!-- 判断是否显示侧边栏 -->
    {% set show_sidebar = (current_group and page not in ['select_group', 'login']) %}

    {% if show_sidebar %}
    <nav class="sidebar">
        <a href="#" class="sidebar-brand"><i class="fa-solid fa-robot me-2"></i> Bot Admin</a>
        <div class="nav flex-column py-3">
            <div class="px-4 mb-2 text-xs fw-bold text-muted text-uppercase" style="font-size: 0.75rem;">当前: {{ current_group.title }}</div>
            <a href="/core/group/{{ current_group.id }}/dashboard" class="nav-link {% if page=='dashboard' %}active{% endif %}"><i class="fa-solid fa-chart-pie"></i> 仪表盘</a>
            <a href="/core/group/{{ current_group.id }}/users" class="nav-link {% if page=='users' %}active{% endif %}"><i class="fa-solid fa-users"></i> 用户管理</a>
            <a href="/core/group/{{ current_group.id }}/fields" class="nav-link {% if page=='fields' %}active{% endif %}"><i class="fa-solid fa-list-check"></i> 资料字段</a>
            <a href="/core/group/{{ current_group.id }}/settings" class="nav-link {% if page=='settings' %}active{% endif %}"><i class="fa-solid fa-sliders"></i> 功能配置</a>
            <hr class="mx-3 my-3 text-muted opacity-25">
            <a href="/core/select_group" class="nav-link text-dark"><i class="fa-solid fa-exchange-alt"></i> 切换群组</a>
            <a href="/core/logout" class="nav-link text-danger"><i class="fa-solid fa-right-from-bracket"></i> 退出登录</a>
        </div>
    </nav>
    {% endif %}

    <div class="main-wrapper" style="margin-left: {{ '250px' if show_sidebar else '0' }};">
        <header class="topbar">
            <h5 class="mb-0 fw-bold text-dark">
                {% if not show_sidebar %}<i class="fa-solid fa-robot me-2 text-primary"></i>Bot Admin{% endif %}
                {% if page=='dashboard' %}数据概览{% endif %}
                {% if page=='users' %}用户管理{% endif %}
                {% if page=='fields' %}字段配置{% endif %}
                {% if page=='settings' %}功能设置{% endif %}
            </h5>
            <div class="d-flex align-items-center">
                {% if current_group and show_sidebar %}
                <a href="https://t.me/{{ current_group.username }}" target="_blank" class="btn btn-sm btn-light text-primary me-2"><i class="fa-brands fa-telegram"></i> 打开群组</a>
                {% endif %}
                {% if session.get('logged_in') and not show_sidebar %}
                <a href="/core/logout" class="btn btn-sm btn-outline-danger">退出</a>
                {% endif %}
            </div>
        </header>

        <div class="content">
            {% block content %}{% endblock %}
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function showToast(msg, type='success') {
            const el = document.getElementById('liveToast');
            document.getElementById('toastMessage').innerText = msg;
            el.className = 'toast align-items-center border-0 shadow-lg text-white';
            if(type === 'success') el.classList.add('bg-success');
            else if(type === 'error') el.classList.add('bg-danger');
            else el.classList.add('bg-secondary');
            new bootstrap.Toast(el, { delay: 2500 }).show();
        }
        async function postApi(url, data) {
            try {
                const r = await fetch(url, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)});
                const j = await r.json();
                if(j.status === 'ok') { showToast(j.msg || '✅ 操作成功', 'success'); setTimeout(() => location.reload(), 1000); } 
                else { showToast(j.msg || '❌ 操作失败', 'error'); }
            } catch(e) { showToast('❌ 网络错误', 'error'); }
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
