{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 fw-bold"><i class="fa-solid fa-users me-2"></i>ç”¨æˆ·åˆ—è¡¨ ({{ group.title }})</h6>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary fw-bold text-nowrap" onclick="openModal()">
                <i class="fa-solid fa-plus"></i> æ·»åŠ ç”¨æˆ·
            </button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light"><tr><th class="ps-4">ID</th><th>èµ„æ–™</th><th>æœ‰æ•ˆæœŸ</th><th>çŠ¶æ€</th><th class="text-end pe-4">æ“ä½œ</th></tr></thead>
            <tbody>
                {% for u in users %}
                <tr id="row_{{ u.id }}">
                    <td class="ps-4 fw-bold text-primary">{{ u.tg_id }}</td>
                    <td>
                        {% set d = u.profile_data | from_json %}
                        {% for k, v in d.items() %}{% if v %}<span class="badge bg-light text-dark border me-1">{{ v }}</span>{% endif %}{% endfor %}
                    </td>
                    <td>
                        {% if u.expiration_date %}
                            <span class="small text-muted">{{ u.expiration_date.strftime('%Y-%m-%d') }}</span>
                            {% if u.is_banned %}<span class="badge bg-danger">å·²ç¦è¨€</span>{% endif %}
                        {% else %}
                            <span class="badge bg-success">æ°¸ä¹…</span>
                        {% endif %}
                    </td>
                    <td><span class="badge {{ 'bg-success' if u.online else 'bg-secondary' }}">{{ 'åœ¨çº¿' if u.online else 'ç¦»çº¿' }}</span></td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-info" onclick="pushUser({{ u.id }})"><i class="fa-solid fa-paper-plane"></i></button>
                        <button class="btn btn-sm btn-outline-primary" onclick="editUser({{ u.id }}, {{ u.tg_id }})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="delUser({{ u.id }})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered"><form class="modal-content" id="userForm" onsubmit="return false">
        <div class="modal-header bg-light"><h5 class="modal-title fw-bold">ç”¨æˆ·ç¼–è¾‘</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="small text-muted fw-bold">Telegram ID</label>
                <input type="number" name="tg_id" class="form-control" required placeholder="è¯·è¾“å…¥æ•°å­—ID">
            </div>
            
            <!-- åŠ¨æ€å­—æ®µåŒº -->
            <div id="modalFields" class="row g-2 mb-3"></div>
            
            <hr>
            
            <!-- ğŸ†• æœ‰æ•ˆæœŸè®¾ç½® -->
            <div class="mb-3">
                <label class="small text-muted fw-bold text-success">å¢åŠ æœ‰æ•ˆæœŸ (å¤©)</label>
                <input type="number" name="add_days" class="form-control" placeholder="0">
                <div class="form-text small">
                    è¾“å…¥å¤©æ•°ä»¥å»¶é•¿æœ‰æ•ˆæœŸã€‚è¾“å…¥ 0 æˆ–ç•™ç©ºåˆ™ä¸æ”¹å˜ã€‚<br>
                    å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œ0 è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆã€‚
                </div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary w-100" onclick="saveUser()">ä¿å­˜</button></div>
    </form></div>
</div>

<script>
    let myModal = null;
    const fields = {{ fields|tojson }};
    const currentGroupId = {{ group.id }};
    const userMap = {};
    {% for u in users %}userMap[{{ u.id }}] = {{ u.profile_data | safe }};{% endfor %}

    document.addEventListener('DOMContentLoaded', ()=> myModal = new bootstrap.Modal(document.getElementById('userModal')));

    function renderFields(data) {
        const con = document.getElementById('modalFields'); con.innerHTML = '';
        fields.forEach(f => {
            let val = data[f.key] || '', html = '';
            if(f.type==='select'){
                let opts=(f.options||[]).map(o=>`<option value="${o}" ${o==val?'selected':''}>${o}</option>`).join('');
                html=`<select name="${f.key}" class="form-select"><option value="">è¯·é€‰æ‹©...</option>${opts}</select>`;
            } else { html=`<input class="form-control" name="${f.key}" value="${val}">`; }
            con.innerHTML+=`<div class="col-12"><label class="small text-muted">${f.label}</label>${html}</div>`;
        });
    }

    function openModal(){ 
        document.getElementById('userForm').reset(); 
        document.querySelector('[name=tg_id]').readOnly = false;
        renderFields({}); 
        myModal.show(); 
    }
    
    function editUser(uid, tgid){ 
        document.getElementById('userForm').reset(); 
        const inp = document.querySelector('[name=tg_id]');
        inp.value = tgid; 
        inp.readOnly = true; // ç¼–è¾‘æ—¶é”å®šID
        renderFields(userMap[uid] || {}); 
        myModal.show(); 
    }
    
    function saveUser(){
        const fd = new FormData(document.getElementById('userForm'));
        const d = { group_id: currentGroupId, tg_id: fd.get('tg_id'), add_days: fd.get('add_days'), profile: {} };
        fields.forEach(f=> d.profile[f.key]=fd.get(f.key));
        
        fetch('/core/api/save_user', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)})
        .then(r=>r.json()).then(res=>{ 
            if(res.status==='ok'){ alert('âœ… ä¿å­˜æˆåŠŸ'); location.reload(); }
            else alert('âŒ ' + res.msg); 
        });
    }
    
    function delUser(id){ if(confirm('ç¡®å®šåˆ é™¤?')) fetch('/core/api/delete_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}).then(()=>location.reload()); }
    function pushUser(id){ if(confirm('æ¨é€?')) fetch('/core/api/push_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}).then(r=>r.json()).then(d=>alert(d.msg)); }
</script>
{% endblock %}
