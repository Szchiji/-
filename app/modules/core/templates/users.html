{% extends "layout_admin.html" %}
{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center bg-white">
        <h6 class="m-0 font-weight-bold text-primary">用户列表</h6>
        <button class="btn btn-primary btn-sm" onclick="openAdd()"><i class="fa-solid fa-plus me-1"></i> 添加用户</button>
    </div>
    <div class="card-body px-0 pt-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small fw-bold"><tr><th class="ps-4">TG ID</th>{% for f in fields %}<th>{{ f.label }}</th>{% endfor %}<th>状态</th><th>过期时间</th><th class="text-end pe-4">管理</th></tr></thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td class="ps-4 fw-bold">{{ u.tg_id }}</td>
                        {% set profile = u.profile_dict %}
                        {% for f in fields %}<td>{{ profile.get(f.key, '') }}</td>{% endfor %}
                        <td>{% if u.online %}<span class="badge bg-success bg-opacity-10 text-success">在线</span>{% else %}<span class="badge bg-secondary bg-opacity-10 text-secondary">离线</span>{% endif %}</td>
                        <td>{% if u.expiration_date %}<span class="small">{{ u.expiration_date.strftime('%Y-%m-%d') }}</span>{% if u.is_banned %}<span class="badge bg-danger">封</span>{% endif %}{% else %}<span class="badge bg-info bg-opacity-10 text-info">永久</span>{% endif %}</td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-light text-warning" onclick="pushUser({{ u.id }})" title="推送"><i class="fa-solid fa-bullhorn"></i></button>
                            <button class="btn btn-sm btn-light text-primary" data-id="{{ u.id }}" data-tgid="{{ u.tg_id }}" data-profile='{{ u.profile_data|safe }}' onclick="openEdit(this)" title="编辑"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn btn-sm btn-light text-danger" onclick="delUser({{ u.id }})" title="删除"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                    {% else %}<tr><td colspan="10" class="text-center py-5 text-muted">暂无数据</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-light border-bottom-0"><h5 class="modal-title fw-bold" id="modalTitle">编辑用户</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><input type="hidden" id="edit_id"><div class="mb-3"><label class="form-label small fw-bold text-muted">TELEGRAM ID</label><input type="number" class="form-control bg-light" id="edit_tg_id"></div>{% for f in fields %}<div class="mb-3"><label class="form-label small fw-bold text-muted">{{ f.label }}</label>{% if f.type == 'select' %}<select class="form-select dynamic-field" data-key="{{ f.key }}"><option value="">请选择</option>{% for opt in (f.options or '').split(',') %}{% if opt.strip() %}<option value="{{ opt.strip() }}">{{ opt.strip() }}</option>{% endif %}{% endfor %}</select>{% else %}<input type="text" class="form-control dynamic-field" data-key="{{ f.key }}">{% endif %}</div>{% endfor %}<div class="alert alert-info border-0 mt-4 d-flex align-items-center"><i class="fa-solid fa-clock me-2"></i><div class="flex-grow-1"><label class="mb-0 fw-bold small">增加有效期 (天)</label><input type="number" class="form-control form-control-sm mt-1" id="edit_add_days" placeholder="0 = 不修改"></div></div></div><div class="modal-footer border-top-0 pt-0 pb-4 pe-4"><button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary px-4" onclick="saveUser()">保存</button></div></div></div></div>
<script>
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    function openAdd() { document.getElementById('modalTitle').innerText='添加用户'; $('#edit_id').val(''); $('#edit_tg_id').val('').prop('disabled',false); $('.dynamic-field').val(''); $('#edit_add_days').val(''); modal.show(); }
    function openEdit(btn) { document.getElementById('modalTitle').innerText='编辑用户'; $('#edit_id').val(btn.getAttribute('data-id')); $('#edit_tg_id').val(btn.getAttribute('data-tgid')).prop('disabled',true); let p={}; try{p=JSON.parse(btn.getAttribute('data-profile'));}catch(e){} $('.dynamic-field').each(function(){let k=$(this).data('key'); if(p&&p[k])$(this).val(p[k]);}); $('#edit_add_days').val(0); modal.show(); }
    async function saveUser() { if(!$('#edit_tg_id').val()) return showToast('请填写ID','danger'); let p={}; $('.dynamic-field').each(function(){p[$(this).data('key')]=$(this).val();}); await postApi('/core/api/save_user', {group_id:{{ group.id }}, tg_id:$('#edit_tg_id').val(), profile:p, add_days:$('#edit_add_days').val()}); }
    async function delUser(id) { if(confirm('确认删除?')) await postApi('/core/api/delete_user', {id:id}); }
    async function pushUser(id) { if(confirm('确认推送?')) await postApi('/core/api/push_user', {id:id}); }
</script>
{% endblock %}
