{% extends "base.html" %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 fw-bold"><i class="fa-solid fa-users me-2"></i>用户列表</h6>
        <div class="d-flex gap-2">
            <input class="form-control form-control-sm" placeholder="搜索..." value="{{ q }}" onchange="location.href='?q='+this.value">
            <!-- 按钮点击事件 -->
            <button class="btn btn-sm btn-primary fw-bold text-nowrap" onclick="openModal()">
                <i class="fa-solid fa-plus"></i> 添加
            </button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light"><tr><th class="ps-4">ID</th><th>资料预览</th><th>状态</th><th class="text-end pe-4">操作</th></tr></thead>
            <tbody>
                {% for u in users %}
                <tr id="row_{{ u.id }}">
                    <td class="ps-4 fw-bold text-primary">{{ u.tg_id }}</td>
                    <td>
                        {% set d = u.profile_data | from_json %}
                        {% for k, v in d.items() %}{% if v %}<span class="badge bg-light text-dark border me-1">{{ v }}</span>{% endif %}{% endfor %}
                    </td>
                    <td><span class="badge {{ 'bg-success' if u.online else 'bg-secondary' }}">{{ '在线' if u.online else '离线' }}</span></td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-info" onclick="pushUser({{ u.id }})"><i class="fa-solid fa-paper-plane"></i></button>
                        <button class="btn btn-sm btn-outline-primary" onclick='editUser({{ u.tg_id }}, {{ u.profile_data|tojson }})'><i class="fa-solid fa-pen"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="delUser({{ u.id }})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal 弹窗 -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" id="userForm" onsubmit="return false">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">编辑用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="small text-muted">Telegram ID (必填)</label>
                    <input type="number" name="tg_id" class="form-control" required placeholder="例如: 12345678">
                </div>
                <div id="modalFields" class="row g-2"></div>
                <div class="mt-3 border-top pt-3">
                    <label class="small text-muted">增加有效期 (天)</label>
                    <input type="number" name="add_days" class="form-control" value="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-primary w-100" onclick="saveUser()">保存</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 定义全局变量
    let myModal = null;
    const fields = {{ fields|tojson }};

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        const el = document.getElementById('userModal');
        if(el) {
            myModal = new bootstrap.Modal(el);
        }
    });

    // 辅助函数：渲染字段
    function renderFields(data) {
        const con = document.getElementById('modalFields'); 
        if(!con) return;
        con.innerHTML = '';
        fields.forEach(f => {
            let val = data[f.key] || '', html = '';
            if(f.type==='select'){
                let opts=(f.options||[]).map(o=>`<option value="${o}" ${o==val?'selected':''}>${o}</option>`).join('');
                html=`<select name="${f.key}" class="form-select"><option value="">请选择...</option>${opts}</select>`;
            } else if(f.type==='checkbox'){
                (f.options||[]).forEach(o=>{ 
                    // 防止 val 为空时的报错
                    let checked = val && val.includes(o) ? 'checked' : '';
                    html+=`<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" name="${f.key}" value="${o}" ${checked}><label class="form-check-label">${o}</label></div>`; 
                });
            } else { 
                html=`<input class="form-control" name="${f.key}" value="${val}">`; 
            }
            con.innerHTML+=`<div class="col-12"><label class="small text-muted">${f.label}</label>${html}</div>`;
        });
    }

    // 核心功能：打开弹窗
    function openModal() {
        // 双重保险：如果未初始化，尝试再次初始化
        if (!myModal) {
            const el = document.getElementById('userModal');
            if(el) myModal = new bootstrap.Modal(el);
            else return alert('错误：弹窗组件未加载');
        }
        
        document.getElementById('userForm').reset(); 
        renderFields({}); 
        myModal.show(); 
    }

    // 编辑用户
    function editUser(id, d) { 
        if (!myModal) {
            const el = document.getElementById('userModal');
            if(el) myModal = new bootstrap.Modal(el);
        }
        document.getElementById('userForm').reset(); 
        document.querySelector('[name=tg_id]').value = id; 
        renderFields(d); 
        myModal.show(); 
    }
    
    // 保存用户
    function saveUser() {
        const form = document.getElementById('userForm');
        if(!form.checkValidity()) { form.reportValidity(); return; }

        const fd = new FormData(form);
        const d = {tg_id:fd.get('tg_id'), add_days:fd.get('add_days'), profile:{}};
        
        fields.forEach(f => {
            if(f.type==='checkbox'){ 
                const v=[]; 
                document.querySelectorAll(`[name="${f.key}"]:checked`).forEach(c=>v.push(c.value)); 
                d.profile[f.key]=v.join(','); 
            }
            else d.profile[f.key]=fd.get(f.key);
        });

        fetch('/core/api/save_user', {
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify(d)
        })
        .then(r=>r.json())
        .then(res => { 
            if(res.status==='ok'){
                myModal.hide();
                alert('✅ 保存成功！'); 
                location.reload(); // 刷新以显示最新列表
            } else {
                alert('❌ 保存失败: ' + res.msg); 
            }
        });
    }

    function delUser(id){ 
        if(confirm('确定删除此用户？')) {
            fetch('/core/api/delete_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})})
            .then(() => {
                document.getElementById('row_'+id).remove();
                alert('✅ 已删除');
            }); 
        }
    }

    function pushUser(id){ 
        if(confirm('确认推送到频道？')) {
            fetch('/core/api/push_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})})
            .then(r=>r.json())
            .then(d=>alert(d.msg)); 
        }
    }
</script>
{% endblock %}
