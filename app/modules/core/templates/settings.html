{% extends "layout_admin.html" %}

{% block content %}
<style>
    /* é¡µé¢ä¸“ç”¨æ ·å¼ */
    .section-title { font-size: 0.8rem; font-weight: 700; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e9ecef; }
    .cursor-pointer { cursor: pointer; user-select: none; }
    .cursor-pointer:hover { opacity: 0.8; transform: translateY(-1px); }
    #editor { 
        min-height: 300px; 
        max-height: 500px; 
        overflow-y: auto; 
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace; 
        font-size: 14px; 
        line-height: 1.6;
        white-space: pre-wrap;
    }
    #editor:focus { background-color: #fcfcfc; }
    /* æ¨¡æ‹Ÿ Telegram æ¶ˆæ¯æ°”æ³¡æ•ˆæœ */
    .msg-bubble { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; }
</style>

<div class="container-fluid p-0">
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-dark mb-1">
                <i class="fa-solid fa-sliders text-primary me-2"></i>åŠŸèƒ½é…ç½®
            </h4>
            <small class="text-muted">å½“å‰ç¾¤ç»„: {{ group.title }}</small>
        </div>
        <button class="btn btn-primary px-4 shadow-sm" onclick="saveSettings()">
            <i class="fa-solid fa-save me-2"></i>ä¿å­˜æ‰€æœ‰é…ç½®
        </button>
    </div>

    <div class="row g-4">
        <!-- å·¦ä¾§ï¼šæ ¸å¿ƒå‚æ•°é…ç½® -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 fw-bold border-bottom">
                    <i class="fa-solid fa-toggle-on text-success me-2"></i>äº¤äº’å‚æ•°è®¾ç½®
                </div>
                <div class="card-body">
                    
                    <!-- 1. æ‰“å¡æ¨¡å— -->
                    <div class="mb-4">
                        <div class="section-title text-primary">æ‰“å¡åŠŸèƒ½</div>
                        <div class="d-flex justify-content-between align-items-center mb-2 bg-light p-2 rounded">
                            <label class="form-check-label fw-bold mb-0" for="checkin_open">å¼€å¯æ‰“å¡</label>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="checkin_open" {{ 'checked' if conf.checkin_open }}>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">è§¦å‘æŒ‡ä»¤ (é€—å·åˆ†éš”)</label>
                            <input id="checkin_cmd" class="form-control form-control-sm" value="{{ conf.checkin_cmd }}" placeholder="ä¾‹å¦‚: æ‰“å¡, ç­¾åˆ°">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">æˆåŠŸæç¤ºè‡ªåŠ¨åˆ é™¤ (ç§’)</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="fa-regular fa-clock"></i></span>
                                <input type="number" id="checkin_del_time" class="form-control" value="{{ conf.checkin_del_time }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2. æŸ¥è¯¢æ¨¡å— -->
                    <div class="mb-4">
                        <div class="section-title text-info">æŸ¥è¯¢åŠŸèƒ½</div>
                        <div class="d-flex justify-content-between align-items-center mb-2 bg-light p-2 rounded">
                            <label class="fw-bold small mb-0">æŒ‡ä»¤æŸ¥è¯¢ (å¦‚"æŸ¥è¯¢")</label>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="query_open" {{ 'checked' if conf.query_open }}>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input id="query_cmd" class="form-control form-control-sm" value="{{ conf.query_cmd }}" placeholder="æŒ‡ä»¤å…³é”®è¯">
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-2 bg-light p-2 rounded">
                            <label class="fw-bold small mb-0">å…³é”®è¯æ¨¡ç³Šæœç´¢</label>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="query_filter_open" {{ 'checked' if conf.query_filter_open }}>
                            </div>
                        </div>
                        <div class="form-text small mb-3">å¼€å¯åï¼Œç”¨æˆ·ç›´æ¥å‘é€ "æ·±åœ³" å³å¯æœåˆ°åŒ…å«æ·±åœ³çš„ç”¨æˆ·ã€‚</div>

                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small text-muted">æ¯é¡µæ˜¾ç¤ºè¡Œæ•°</label>
                                <input type="number" id="page_size" class="form-control form-control-sm" value="{{ conf.page_size }}">
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">åˆ—è¡¨è‡ªåŠ¨åˆ é™¤(ç§’)</label>
                                <input type="number" id="query_del_time" class="form-control form-control-sm" value="{{ conf.query_del_time }}">
                            </div>
                        </div>
                    </div>

                    <!-- 3. å…¶ä»–è®¾ç½® -->
                    <div class="mb-3">
                        <div class="section-title text-warning">å…¶ä»–å¢å¼º</div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="small fw-bold mb-0">è®¤è¯ç”¨æˆ·å‘è¨€è‡ªåŠ¨ç‚¹èµ</label>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="auto_like" {{ 'checked' if conf.auto_like }}>
                            </div>
                        </div>
                        <div class="input-group input-group-sm mb-3">
                            <span class="input-group-text">è¡¨æƒ…</span>
                            <input id="like_emoji" class="form-control" value="{{ conf.like_emoji }}" placeholder="â¤ï¸">
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 border border-danger rounded bg-danger bg-opacity-10">
                            <label class="small fw-bold text-danger mb-0">è¿‡æœŸè‡ªåŠ¨ç¦è¨€</label>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="auto_mute_expired" {{ 'checked' if conf.auto_mute_expired }}>
                            </div>
                        </div>

                        <div class="mb-0">
                            <label class="small fw-bold text-muted">æ¨é€é¢‘é“ ID (å¯é€‰)</label>
                            <input id="push_channel_id" class="form-control form-control-sm" value="{{ conf.push_channel_id or '' }}" placeholder="-100xxxxxxx">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ä¸æŒ‰é’® -->
        <div class="col-lg-8">
            <!-- æ–‡æ¡ˆç¼–è¾‘å™¨ -->
            <div class="card border-0 shadow-sm mb-4 h-100">
                <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center border-bottom">
                    <div class="d-flex align-items-center">
                        <i class="fa-solid fa-pen-nib text-secondary me-2"></i>
                        <select class="form-select form-select-sm fw-bold border-0 bg-light" id="msgSelector" onchange="loadMsg()" style="width: 200px;">
                            <optgroup label="åˆ—è¡¨ä¸æ˜¾ç¤º">
                                <option value="template">ğŸ“‹ åˆ—è¡¨å•è¡Œæ¨¡æ¿</option>
                                <option value="msg_query_header">ğŸ“ æ™®é€šæŸ¥è¯¢æŠ¬å¤´</option>
                                <option value="msg_filter_header">ğŸ” ç­›é€‰æŸ¥è¯¢æŠ¬å¤´</option>
                            </optgroup>
                            <optgroup label="ç³»ç»Ÿæç¤º">
                                <option value="msg_checkin_success">âœ… æ‰“å¡æˆåŠŸæ¶ˆæ¯</option>
                                <option value="msg_not_registered">âš ï¸ æœªè®¤è¯æç¤º</option>
                                <option value="msg_repeat_checkin">ğŸ”„ é‡å¤æ‰“å¡æç¤º</option>
                                <option value="msg_expired_ban">â›”ï¸ è¿‡æœŸç¦è¨€æç¤º</option>
                            </optgroup>
                            <optgroup label="æ¨é€">
                                <option value="push_template">ğŸ“¢ é¢‘é“æ¨é€æ¨¡æ¿</option>
                            </optgroup>
                        </select>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="saveTmp()">æš‚å­˜ä¿®æ”¹</button>
                </div>
                
                <div class="card-body p-0 d-flex flex-column msg-bubble mx-3 my-3">
                    <!-- å¿«æ·æ’å…¥å·¥å…·æ  -->
                    <div class="bg-light p-2 border-bottom d-flex gap-2 flex-wrap align-items-center">
                        <small class="text-muted fw-bold me-2">æ’å…¥å˜é‡:</small>
                        
                        <span class="badge bg-white text-dark border cursor-pointer shadow-sm" onclick="insert('{onlineEmoji}')">ğŸŸ¢åœ¨çº¿çŠ¶æ€</span>
                        <span class="badge bg-white text-dark border cursor-pointer shadow-sm" onclick="insert('{åºå·}')">#ï¸âƒ£åºå·</span>
                        <span class="badge bg-white text-dark border cursor-pointer shadow-sm" onclick="insert('{tg_id}')">ğŸ†”ç”¨æˆ·ID</span>
                        
                        <div class="vr mx-1"></div>
                        <!-- åŠ¨æ€å­—æ®µ -->
                        {% for f in fields %}
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary cursor-pointer" onclick="insert('{'+'{{ f.label }}'+'}')">{{ f.label }}</span>
                        {% endfor %}
                        
                        <div class="vr mx-1"></div>
                        <!-- æ ¼å¼åŒ–å·¥å…· -->
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-light border" onclick="cmd('bold')" title="åŠ ç²—"><b>B</b></button>
                            <button class="btn btn-light border" onclick="link()" title="é“¾æ¥"><i class="fa-solid fa-link"></i></button>
                            <button class="btn btn-light border" onclick="cmd('removeFormat')" title="æ¸…é™¤æ ¼å¼"><i class="fa-solid fa-eraser"></i></button>
                        </div>
                    </div>
                    
                    <!-- ç¼–è¾‘åŒºåŸŸ -->
                    <div id="editor" contenteditable="true" class="p-3 flex-grow-1"></div>
                </div>
                <div class="card-footer bg-white text-muted small border-top-0">
                    <i class="fa-solid fa-circle-info me-1"></i> æ”¯æŒ HTML æ ‡ç­¾ï¼Œå¦‚ &lt;b&gt;ç²—ä½“&lt;/b&gt;, &lt;a href="..."&gt;é“¾æ¥&lt;/a&gt;ã€‚åˆ‡æ¢ä¸‹æ‹‰èœå•å‰è¯·ç‚¹å‡»"æš‚å­˜ä¿®æ”¹"ã€‚
                </div>
            </div>

            <!-- è‡ªå®šä¹‰æŒ‰é’®é…ç½® -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white py-3 fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-keyboard text-secondary me-2"></i>è‡ªå®šä¹‰æŒ‰é’® (æŸ¥è¯¢ç»“æœåº•éƒ¨)</span>
                    <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="addBtn()">
                        <i class="fa-solid fa-plus me-1"></i>æ·»åŠ æŒ‰é’®
                    </button>
                </div>
                <div class="card-body bg-light">
                    <div id="btnContainer" class="row g-3"></div>
                    <textarea id="custom_buttons" class="form-control d-none">{{ conf.custom_buttons }}</textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–æ•°æ® (é˜²æ­¢åç«¯ä¼ ç©ºå€¼æŠ¥é”™)
    let msgs = {
        template: `{{ conf.template|default('')|safe }}`,
        push_template: `{{ conf.push_template|default('')|safe }}`,
        msg_checkin_success: `{{ conf.msg_checkin_success|default('âœ… æ‰“å¡æˆåŠŸ')|safe }}`,
        msg_not_registered: `{{ conf.msg_not_registered|default('âš ï¸ æ‚¨æœªè®¤è¯')|safe }}`,
        msg_repeat_checkin: `{{ conf.msg_repeat_checkin|default('ğŸ”„ ä»Šæ—¥å·²æ‰“å¡')|safe }}`,
        msg_query_header: `{{ conf.msg_query_header|default('ğŸ“ æŸ¥è¯¢ç»“æœ')|safe }}`,
        msg_filter_header: `{{ conf.msg_filter_header|default('ğŸ” ç­›é€‰ç»“æœ')|safe }}`,
        msg_expired_ban: `{{ conf.msg_expired_ban|default('â›”ï¸ æ‚¨çš„æœåŠ¡å·²è¿‡æœŸ')|safe }}`
    };
    
    const currentGroupId = {{ group.id }};
    let btnData = [];
    try { 
        btnData = JSON.parse(document.getElementById('custom_buttons').value || '[]'); 
    } catch(e) { btnData = []; }

    // åˆå§‹åŒ–è¿è¡Œ
    document.addEventListener('DOMContentLoaded', () => { 
        loadMsg(); 
        renderBtns(); 
    });

    // --- æŒ‰é’®ç®¡ç† ---
    function renderBtns() {
        const con = document.getElementById('btnContainer');
        con.innerHTML = '';
        btnData.forEach((b, i) => {
            con.innerHTML += `
                <div class="col-md-6">
                    <div class="card border p-2 shadow-sm">
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text bg-white">æ–‡å­—</span>
                            <input type="text" class="form-control" value="${b.text}" onchange="updateBtn(${i}, 'text', this.value)">
                        </div>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white">é“¾æ¥</span>
                            <input type="text" class="form-control" value="${b.url}" onchange="updateBtn(${i}, 'url', this.value)">
                            <button class="btn btn-danger" onclick="delBtn(${i})"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `;
        });
        if(btnData.length === 0) con.innerHTML = '<div class="text-center text-muted w-100 py-3 small">æš‚æ— è‡ªå®šä¹‰æŒ‰é’®</div>';
    }
    
    function addBtn() { btnData.push({text:'', url:''}); renderBtns(); }
    function delBtn(i) { btnData.splice(i, 1); renderBtns(); }
    function updateBtn(i, key, val) { btnData[i][key] = val; }

    // --- æ–‡æ¡ˆç¼–è¾‘å™¨ ---
    function loadMsg() { 
        const key = document.getElementById('msgSelector').value;
        document.getElementById('editor').innerHTML = msgs[key] || ''; 
    }
    
    function saveTmp() { 
        // æš‚å­˜å½“å‰ç¼–è¾‘å™¨çš„å†…å®¹åˆ° msgs å¯¹è±¡
        let content = document.getElementById('editor').innerHTML;
        // æ¸…ç†ä¸€ä¸‹ä¸å¿…è¦çš„ nbsp
        content = content.replace(/&nbsp;/g, ' '); 
        msgs[document.getElementById('msgSelector').value] = content;
        
        // è§†è§‰åé¦ˆ
        const btn = document.querySelector('button[onclick="saveTmp()"]');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²æš‚å­˜';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        setTimeout(() => {
            btn.innerHTML = oldText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 800);
    }
    
    function cmd(c,v){ document.getElementById('editor').focus(); document.execCommand(c,false,v); }
    
    function insert(text) {
        document.getElementById('editor').focus();
        document.execCommand('insertText', false, text);
    }
    
    function link(){ let u=prompt('è¾“å…¥é“¾æ¥åœ°å€ (URL):'); if(u) cmd('createLink',u); }
    
    // --- ä¿å­˜æ€»é…ç½® ---
    function saveSettings() {
        saveTmp(); // æäº¤å‰å…ˆæš‚å­˜å½“å‰ç¼–è¾‘æ¡†
        
        // æ”¶é›†æ‰€æœ‰æ•°æ®
        const d = {
            group_id: currentGroupId,
            config: {
                ...msgs, // å±•å¼€æ‰€æœ‰æ–‡æ¡ˆ
                
                checkin_open: document.getElementById('checkin_open').checked,
                checkin_cmd: document.getElementById('checkin_cmd').value,
                checkin_del_time: document.getElementById('checkin_del_time').value, 
                
                query_open: document.getElementById('query_open').checked,
                query_cmd: document.getElementById('query_cmd').value,
                query_filter_open: document.getElementById('query_filter_open').checked,
                query_del_time: document.getElementById('query_del_time').value,
                
                page_size: document.getElementById('page_size').value,
                
                auto_like: document.getElementById('auto_like').checked,
                like_emoji: document.getElementById('like_emoji').value,
                auto_mute_expired: document.getElementById('auto_mute_expired').checked,

                push_channel_id: document.getElementById('push_channel_id').value,
                // è¿‡æ»¤æ‰ç©ºæŒ‰é’®
                custom_buttons: JSON.stringify(btnData.filter(b => b.text && b.url)), 
                
                // ä¿æŒåŸæœ‰çš„è¡¨æƒ…è®¾ç½®
                online_emoji: "{{ conf.online_emoji }}", 
                offline_emoji: "{{ conf.offline_emoji }}"
            }
        };
        
        // å‘é€è¯·æ±‚ (ä½¿ç”¨ base.html ä¸­å®šä¹‰çš„ postApi)
        postApi('/core/api/save_settings', d);
    }
</script>
{% endblock %}
