{% extends "base.html" %}

{% block content %}
<style>#editor { min-height: 300px; max-height: 500px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; background: #fff; }</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div><h4 class="fw-bold mb-1">åŠŸèƒ½é…ç½®</h4></div>
    <button class="btn btn-primary px-4 shadow-sm" onclick="saveSettings()"><i class="fa-solid fa-save me-2"></i>ä¿å­˜æ‰€æœ‰é…ç½®</button>
</div>

<div class="row g-4">
    <!-- å·¦ä¾§å‚æ•° -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white fw-bold py-3">åŸºç¡€å‚æ•°</div>
            <div class="card-body">
                <div class="mb-4">
                    <h6 class="text-primary fw-bold small">æ‰“å¡</h6>
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="checkin_open" {{ 'checked' if conf.checkin_open }}><label>å¼€å¯æ‰“å¡</label></div>
                    <input id="checkin_cmd" class="form-control form-control-sm mb-2" value="{{ conf.checkin_cmd }}" placeholder="æŒ‡ä»¤: æ‰“å¡">
                    <input type="number" id="checkin_del_time" class="form-control form-control-sm" value="{{ conf.checkin_del_time }}" placeholder="åˆ é™¤æ—¶é—´(ç§’)">
                </div>
                <div class="mb-4">
                    <h6 class="text-info fw-bold small">æŸ¥è¯¢</h6>
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="query_open" {{ 'checked' if conf.query_open }}><label>å¼€å¯æŸ¥è¯¢</label></div>
                    <input id="query_cmd" class="form-control form-control-sm mb-2" value="{{ conf.query_cmd }}" placeholder="æŒ‡ä»¤: æŸ¥è¯¢">
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="query_filter_open" {{ 'checked' if conf.query_filter_open }}><label>å…³é”®è¯æœç´¢</label></div>
                    <div class="row g-2">
                        <div class="col-6"><input type="number" id="page_size" class="form-control form-control-sm" value="{{ conf.page_size }}" placeholder="è¡Œæ•°"></div>
                        <div class="col-6"><input type="number" id="query_del_time" class="form-control form-control-sm" value="{{ conf.query_del_time }}" placeholder="åˆ é™¤(ç§’)"></div>
                    </div>
                </div>
                <div>
                    <h6 class="text-warning fw-bold small">å…¶ä»–</h6>
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="auto_like" {{ 'checked' if conf.auto_like }}><label>è‡ªåŠ¨ç‚¹èµ</label></div>
                    <input id="like_emoji" class="form-control form-control-sm mb-2" value="{{ conf.like_emoji }}" placeholder="è¡¨æƒ…">
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="auto_mute_expired" {{ 'checked' if conf.auto_mute_expired }}><label class="text-danger">è¿‡æœŸè‡ªåŠ¨ç¦è¨€</label></div>
                    <input id="push_channel_id" class="form-control form-control-sm" value="{{ conf.push_channel_id or '' }}" placeholder="æ¨é€é¢‘é“ID">
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§æ–‡æ¡ˆ -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <select class="form-select form-select-sm w-auto fw-bold border-0 bg-light" id="msgSelector" onchange="loadMsg()">
                    <option value="template">ğŸ“‹ åˆ—è¡¨å•è¡Œæ¨¡æ¿</option>
                    <option value="msg_checkin_success">âœ… æ‰“å¡æˆåŠŸ</option>
                    <option value="msg_not_registered">âš ï¸ æœªè®¤è¯</option>
                    <option value="msg_repeat_checkin">ğŸ”„ é‡å¤æ‰“å¡</option>
                    <option value="push_template">ğŸ“¢ æ¨é€æ¨¡æ¿</option>
                </select>
                <button class="btn btn-sm btn-outline-secondary" onclick="saveTmp()">æš‚å­˜æ–‡æ¡ˆ</button>
            </div>
            <div class="card-body">
                <div class="bg-light p-2 border-bottom d-flex gap-2 flex-wrap mb-2">
                    <span class="badge bg-white text-dark border cursor-pointer" onclick="insert('{onlineEmoji}')">ğŸŸ¢åœ¨çº¿</span>
                    <span class="badge bg-white text-dark border cursor-pointer" onclick="insert('{åºå·}')">#ï¸âƒ£åºå·</span>
                    <span class="badge bg-white text-dark border cursor-pointer" onclick="insert('{tg_id}')">ğŸ†”ID</span>
                    {% for f in fields %}
                    <span class="badge bg-primary bg-opacity-10 text-primary border cursor-pointer" onclick="insert('{'+'{{ f.label }}'+'}')">{{ f.label }}</span>
                    {% endfor %}
                </div>
                <div id="editor" contenteditable="true"></div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white fw-bold d-flex justify-content-between">
                <span>è‡ªå®šä¹‰æŒ‰é’®</span>
                <button class="btn btn-sm btn-outline-primary" onclick="addBtn()">+ æ·»åŠ </button>
            </div>
            <div class="card-body bg-light">
                <div id="btnContainer" class="row g-3"></div>
                <textarea id="custom_buttons" class="form-control d-none">{{ conf.custom_buttons }}</textarea>
            </div>
        </div>
    </div>
</div>

<script>
    let msgs={template:`{{ conf.template|default('')|safe }}`, push_template:`{{ conf.push_template|default('')|safe }}`, msg_checkin_success:`{{ conf.msg_checkin_success|default('')|safe }}`, msg_not_registered:`{{ conf.msg_not_registered|default('')|safe }}`, msg_repeat_checkin:`{{ conf.msg_repeat_checkin|default('')|safe }}`};
    let btnData=[]; try{btnData=JSON.parse($('#custom_buttons').val()||'[]');}catch(e){}

    function renderBtns(){$('#btnContainer').html(btnData.map((b,i)=>`<div class="col-md-6"><div class="input-group input-group-sm"><span class="input-group-text">æ–‡</span><input class="form-control" value="${b.text}" onchange="btnData[${i}].text=this.value"><span class="input-group-text">é“¾</span><input class="form-control" value="${b.url}" onchange="btnData[${i}].url=this.value"><button class="btn btn-danger" onclick="btnData.splice(${i},1);renderBtns()">Ã—</button></div></div>`).join('')||'<div class="text-center w-100 text-muted small">æ— æŒ‰é’®</div>');}
    function addBtn(){btnData.push({text:'',url:''});renderBtns();}
    
    function loadMsg(){$('#editor').html(msgs[$('#msgSelector').val()]||'');}
    function saveTmp(){msgs[$('#msgSelector').val()]=$('#editor').html(); showToast('å·²æš‚å­˜','success');}
    function insert(t){document.getElementById('editor').focus();document.execCommand('insertText',false,t);}
    
    async function saveSettings(){
        saveTmp(); 
        const d={
            group_id:{{ group.id }}, 
            config:{
                ...msgs, 
                checkin_open:$('#checkin_open').is(':checked'), checkin_cmd:$('#checkin_cmd').val(), checkin_del_time:$('#checkin_del_time').val(), 
                query_open:$('#query_open').is(':checked'), query_cmd:$('#query_cmd').val(), query_filter_open:$('#query_filter_open').is(':checked'), query_del_time:$('#query_del_time').val(), page_size:$('#page_size').val(), 
                auto_like:$('#auto_like').is(':checked'), like_emoji:$('#like_emoji').val(), auto_mute_expired:$('#auto_mute_expired').is(':checked'), 
                push_channel_id:$('#push_channel_id').val(), custom_buttons:JSON.stringify(btnData.filter(b=>b.text&&b.url)), 
                online_emoji:"{{ conf.online_emoji }}"
            }
        }; 
        await postApi('/core/api/save_settings',d);
    }
    $(()=>{loadMsg();renderBtns();});
</script>
{% endblock %}
