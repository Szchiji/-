{% extends "base.html" %}
{% block content %}
<style>
    /* æŒ‰é’®è¡Œæ ·å¼ */
    .btn-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .btn-row .form-control { flex: 1; }
    /* ç¼–è¾‘å™¨æ ·å¼ä¼˜åŒ– */
    #editor { white-space: pre-wrap; word-break: break-word; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0"><i class="fa-solid fa-sliders me-2"></i>åŠŸèƒ½é…ç½® ({{ group.title }})</h4>
    <button class="btn btn-primary fw-bold px-4" onclick="saveSettings()">
        <i class="fa-solid fa-save me-2"></i> ä¿å­˜é…ç½®
    </button>
</div>

<div class="row">
    <!-- å·¦ä¾§ï¼šå‚æ•°é…ç½® -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white fw-bold py-3">äº¤äº’å‚æ•°</div>
            <div class="card-body">
                <!-- æ‰“å¡æ¨¡å— -->
                <div class="p-3 bg-light rounded mb-3">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="checkin_open" {{ 'checked' if conf.checkin_open }}>
                        <label class="fw-bold">å¼€å¯æ‰“å¡</label>
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">æŒ‡ä»¤ (ä¸è‡ªåŠ¨åˆ é™¤)</label>
                        <input id="checkin_cmd" class="form-control form-control-sm" value="{{ conf.checkin_cmd }}" placeholder="æ‰“å¡, ä¸Šç­">
                    </div>
                    <div class="mb-0">
                        <label class="small text-muted">ç»“æœåˆ é™¤æ—¶é—´ (ç§’)</label>
                        <input type="number" id="checkin_del_time" class="form-control form-control-sm" value="{{ conf.checkin_del_time }}">
                    </div>
                </div>
                
                <!-- æŸ¥è¯¢æ¨¡å— -->
                <div class="p-3 bg-light rounded mb-3">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="query_open" {{ 'checked' if conf.query_open }}>
                        <label class="fw-bold">å¼€å¯æ™®é€šæŸ¥è¯¢</label>
                    </div>
                    <div class="mb-2">
                        <label class="small text-muted">æ™®é€šæŸ¥è¯¢æŒ‡ä»¤ (æ˜¾ç¤ºå…¨å‘˜)</label>
                        <input id="query_cmd" class="form-control form-control-sm" value="{{ conf.query_cmd }}" placeholder="æŸ¥è¯¢">
                    </div>

                    <hr class="my-2">

                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="query_filter_open" {{ 'checked' if conf.query_filter_open }}>
                        <label class="fw-bold">å¼€å¯ç­›é€‰(å ä½ç¬¦)æŸ¥è¯¢</label>
                    </div>
                    <div class="mb-2">
                        <div class="form-text small">æ”¯æŒå‘é€ "å…³é”®è¯" ç›´æ¥æœç´¢</div>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="small text-muted">æ¯é¡µè¡Œæ•°</label>
                            <input type="number" id="page_size" class="form-control form-control-sm" value="{{ conf.page_size }}">
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">åˆ é™¤æ—¶é—´(ç§’)</label>
                            <input type="number" id="query_del_time" class="form-control form-control-sm" value="{{ conf.query_del_time }}">
                        </div>
                    </div>
                </div>

                <!-- äº’åŠ¨æ¨¡å— -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label class="small text-muted">è‡ªåŠ¨ç‚¹èµ (å¼ºåˆ¶)</label>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="auto_like" {{ 'checked' if conf.auto_like }}>
                        </div>
                    </div>
                    <input id="like_emoji" class="form-control form-control-sm" value="{{ conf.like_emoji }}" placeholder="â¤ï¸">
                </div>

                <!-- ç¦è¨€è®¾ç½® -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="auto_mute_expired" {{ 'checked' if conf.auto_mute_expired }}>
                    <label class="fw-bold text-danger">è¿‡æœŸè‡ªåŠ¨ç¦è¨€</label>
                </div>

                <!-- æ¨é€é¢‘é“ -->
                <div class="mb-3">
                    <label class="small text-muted fw-bold text-success">æ¨é€é¢‘é“ ID</label>
                    <input id="push_channel_id" class="form-control form-control-sm" value="{{ conf.push_channel_id or '' }}" placeholder="-100xxxxxxx">
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæ–‡æ¡ˆä¸æŒ‰é’® -->
    <div class="col-lg-8 mb-4">
        <!-- 1. æ–‡æ¡ˆç¼–è¾‘å™¨ -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <span class="fw-bold">æ–‡æ¡ˆä¸æ¨¡æ¿</span>
                <select class="form-select form-select-sm w-auto border-primary text-primary fw-bold" id="msgSelector" onchange="loadMsg()">
                    <option value="template">ğŸ‘¤ åˆ—è¡¨å•è¡Œæ¨¡æ¿</option>
                    <option value="msg_query_header">ğŸ“ æ™®é€šæŸ¥è¯¢æŠ¬å¤´</option>
                    <option value="msg_filter_header">ğŸ” ç­›é€‰æŸ¥è¯¢æŠ¬å¤´</option>
                    <option value="push_template">ğŸ“¢ é¢‘é“æ¨é€æ¨¡æ¿</option>
                    <option value="msg_checkin_success">âœ… æ‰“å¡æˆåŠŸæ¶ˆæ¯</option>
                    <option value="msg_not_registered">âš ï¸ æœªè®¤è¯æç¤º</option>
                    <option value="msg_repeat_checkin">ğŸ”„ é‡å¤æ‰“å¡æç¤º</option>
                </select>
            </div>
            <div class="card-body d-flex flex-column p-0">
                <!-- å·¥å…·æ  -->
                <div class="p-2 bg-light border-bottom d-flex flex-wrap gap-2 align-items-center">
                    <div class="btn-group bg-white border rounded shadow-sm">
                        <button class="btn btn-sm btn-light" onclick="exec('bold')"><b>B</b></button>
                        <button class="btn btn-sm btn-light" onclick="exec('italic')"><i>I</i></button>
                        <button class="btn btn-sm btn-light" onclick="addLink()">ğŸ”—</button>
                        <button class="btn btn-sm btn-light" onclick="exec('removeFormat')">ğŸ§¹</button>
                    </div>
                    <div class="vr mx-1"></div>
                    <span class="badge bg-white text-dark border cursor-pointer" onclick="insertHtml('{onlineEmoji}')">ğŸŸ¢è¡¨æƒ…</span>
                    <span class="badge bg-info text-dark border cursor-pointer" onclick="insertHtml('{åºå·}')">#ï¸âƒ£åºå·</span>
                    {% for f in fields %}
                    <span class="badge bg-white text-primary border cursor-pointer" onclick="insertHtml('{'+'{{ f.label }}'+'}')">{{ f.label }}</span>
                    {% endfor %}
                    <span class="badge bg-warning text-dark border cursor-pointer" onclick="insertHtml('{tg_id}')">TG_ID</span>
                </div>
                
                <!-- ç¼–è¾‘åŒºåŸŸ -->
                <div id="editor" class="p-3 flex-grow-1" contenteditable="true" style="outline:none; min-height: 200px;"></div>
                
                <div class="p-2 border-top bg-light text-end">
                    <button class="btn btn-sm btn-secondary" onclick="saveTmp()">æš‚å­˜å½“å‰æ–‡æ¡ˆ</button>
                </div>
            </div>
        </div>

        <!-- 2. æŒ‰é’®ç”Ÿæˆå™¨ -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <span class="fw-bold">è‡ªå®šä¹‰æŒ‰é’® (åˆ—è¡¨åº•éƒ¨)</span>
                <button class="btn btn-sm btn-success" onclick="addButtonRow()"><i class="fa-solid fa-plus"></i> æ·»åŠ ä¸€è¡Œ</button>
            </div>
            <div class="card-body bg-light" id="btnContainer">
                <!-- åŠ¨æ€ç”ŸæˆæŒ‰é’®è¡Œ -->
            </div>
            <div class="card-footer bg-white text-muted small">
                æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªæŒ‰é’®ã€‚
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. ç¼–è¾‘å™¨é€»è¾‘ (å…‰æ ‡è®°å¿† + ç©ºæ ¼ä¿®å¤) ---
    let savedRange = null;
    const editor = document.getElementById('editor');

    // ç›‘å¬å…‰æ ‡å˜åŒ–ï¼Œå®æ—¶è®°å½•ä½ç½®
    document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        if (sel.rangeCount > 0 && editor.contains(sel.anchorNode)) {
            savedRange = sel.getRangeAt(0);
        }
    });

    // å¤±å»ç„¦ç‚¹æ—¶ä¸è¦æ¸…ç©º rangeï¼Œè€Œæ˜¯ä¿æŒæœ€åçŠ¶æ€
    editor.addEventListener('blur', () => {}); 

    function exec(cmd, val) {
        restoreSelection();
        document.execCommand(cmd, false, val);
        editor.focus();
    }

    function addLink() {
        const url = prompt('è¾“å…¥é“¾æ¥ URL:');
        if (url) exec('createLink', url);
    }

    function insertHtml(html) {
        restoreSelection();
        document.execCommand('insertText', false, html); // ä½¿ç”¨ insertText é¿å…æ’å…¥å¤šä½™çš„ span æ ·å¼
        editor.focus();
    }

    function restoreSelection() {
        editor.focus();
        if (savedRange) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(savedRange);
        }
    }

    // --- 2. æŒ‰é’®ç”Ÿæˆå™¨é€»è¾‘ ---
    // åˆå§‹æ•°æ®
    let loadedButtons = [];
    try {
        loadedButtons = JSON.parse(`{{ conf.custom_buttons|safe }}` || '[]');
    } catch(e) { loadedButtons = []; }

    const btnContainer = document.getElementById('btnContainer');

    function renderButtons() {
        btnContainer.innerHTML = '';
        loadedButtons.forEach((btn, index) => {
            const row = document.createElement('div');
            row.className = 'btn-row';
            row.innerHTML = `
                <div class="input-group input-group-sm">
                    <span class="input-group-text">æ–‡æ¡ˆ</span>
                    <input type="text" class="form-control btn-text" value="${btn.text}">
                </div>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">é“¾æ¥</span>
                    <input type="text" class="form-control btn-url" value="${btn.url}">
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeBtn(${index})"><i class="fa-solid fa-trash"></i></button>
            `;
            btnContainer.appendChild(row);
        });
        if (loadedButtons.length === 0) {
            btnContainer.innerHTML = '<div class="text-center text-muted py-3">æš‚æ— æŒ‰é’®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div>';
        }
    }

    function addButtonRow() {
        loadedButtons.push({text: '', url: ''});
        renderButtons();
    }

    function removeBtn(index) {
        loadedButtons.splice(index, 1);
        renderButtons();
    }

    function collectButtons() {
        const res = [];
        document.querySelectorAll('.btn-row').forEach(row => {
            const t = row.querySelector('.btn-text').value.trim();
            const u = row.querySelector('.btn-url').value.trim();
            if(t && u) res.push({text: t, url: u});
        });
        return JSON.stringify(res);
    }

    // --- 3. é…ç½®ä¿å­˜é€»è¾‘ ---
    let msgs = {
        template: `{{ conf.template|safe }}`,
        push_template: `{{ conf.push_template|safe }}`,
        msg_checkin_success: `{{ conf.msg_checkin_success|safe }}`,
        msg_not_registered: `{{ conf.msg_not_registered|safe }}`,
        msg_repeat_checkin: `{{ conf.msg_repeat_checkin|safe }}`,
        msg_query_header: `{{ conf.msg_query_header|safe }}`,
        msg_filter_header: `{{ conf.msg_filter_header|safe }}`
    };
    
    const currentGroupId = {{ group.id }};
    document.addEventListener('DOMContentLoaded', () => {
        loadMsg();
        renderButtons(); // æ¸²æŸ“æŒ‰é’®
    });

    function loadMsg() { 
        if(!msgs.msg_filter_header) msgs.msg_filter_header = "ğŸ” <b>ç­›é€‰ç»“æœï¼š</b>\n";
        document.getElementById('editor').innerHTML = msgs[document.getElementById('msgSelector').value] || ''; 
    }
    
    function saveTmp() { 
        // âš¡ï¸ ä¿®å¤ç©ºæ ¼é—®é¢˜ï¼šæ›¿æ¢ &nbsp; ä¸ºæ™®é€šç©ºæ ¼
        let content = document.getElementById('editor').innerHTML;
        content = content.replace(/&nbsp;/g, ' '); 
        msgs[document.getElementById('msgSelector').value] = content;
        
        const btn = document.querySelector('.btn-secondary');
        btn.innerHTML = 'å·²æš‚å­˜'; setTimeout(() => btn.innerHTML = 'æš‚å­˜', 500);
    }
    
    function saveSettings() {
        saveTmp(); 
        const d = {
            group_id: currentGroupId,
            config: {
                ...msgs,
                checkin_open: document.getElementById('checkin_open').checked,
                checkin_cmd: document.getElementById('checkin_cmd').value,
                
                query_open: document.getElementById('query_open').checked, // æ™®é€šæŸ¥è¯¢å¼€å…³
                query_cmd: document.getElementById('query_cmd').value,
                
                query_filter_open: document.getElementById('query_filter_open').checked, // ç­›é€‰å¼€å…³
                
                page_size: document.getElementById('page_size').value,
                checkin_del_time: document.getElementById('checkin_del_time').value,
                query_del_time: document.getElementById('query_del_time').value,
                
                auto_like: document.getElementById('auto_like').checked,
                like_emoji: document.getElementById('like_emoji').value,
                auto_mute_expired: document.getElementById('auto_mute_expired').checked,

                push_channel_id: document.getElementById('push_channel_id').value,
                custom_buttons: collectButtons(), // âš¡ï¸ æ”¶é›†æŒ‰é’®æ•°æ®
                
                online_emoji: "{{ conf.online_emoji }}", 
                offline_emoji: "{{ conf.offline_emoji }}"
            }
        };
        fetch('/core/api/save_settings', {
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)
        }).then(()=>alert('âœ… é…ç½®å·²ä¿å­˜'));
    }
</script>
<style>.cursor-pointer:hover{opacity:0.8}</style>
{% endblock %}
