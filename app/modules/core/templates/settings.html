{% extends "base.html" %}
{% block content %}
<style>
    .btn-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .btn-row .form-control { flex: 1; }
    #editor { white-space: pre-wrap; word-break: break-word; }
    .section-title { font-size: 0.85rem; font-weight: 700; color: #6c757d; text-transform: uppercase; margin-bottom: 0.5rem; }
    
    .settings-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
    }
    
    .config-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    .config-card:hover {
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        transform: translateY(-5px);
    }
    
    .config-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 2px solid #f0f0f0;
        transition: all 0.3s ease;
    }
    
    .config-section:hover {
        border-color: #4facfe;
        box-shadow: 0 5px 15px rgba(79, 172, 254, 0.1);
    }
    
    .editor-toolbar {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-bottom: 2px solid #e0e0e0;
        padding: 1rem;
        border-radius: 10px 10px 0 0;
    }
    
    .editor-content {
        border-radius: 0 0 10px 10px;
        min-height: 250px;
        padding: 1.5rem;
        background: white;
    }
    
    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
        cursor: pointer;
    }
    
    .form-switch .form-check-input:checked {
        background-color: #4facfe;
        border-color: #4facfe;
    }
    
    .template-selector {
        border-radius: 10px;
        border: 2px solid #4facfe;
        padding: 0.6rem 1rem;
        font-weight: 600;
        background: white;
    }
    
    .btn-toolbar-action {
        border: none;
        background: white;
        padding: 0.5rem 0.8rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-toolbar-action:hover {
        background: #4facfe;
        color: white;
        transform: scale(1.1);
    }
    
    .badge-variable {
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0.5rem 1rem;
        font-weight: 600;
    }
    
    .badge-variable:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
</style>

<div class="settings-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="fw-bold mb-1"><i class="fa-solid fa-sliders me-2"></i>åŠŸèƒ½é…ç½®</h4>
            <p class="mb-0 opacity-75">{{ group.title }} - é…ç½®æœºå™¨äººè¡Œä¸ºå’Œç•Œé¢</p>
        </div>
        <button class="btn btn-light fw-bold px-4" onclick="saveSettings()">
            <i class="fa-solid fa-save me-2"></i>ä¿å­˜å…¨éƒ¨é…ç½®
        </button>
    </div>
</div>

<div class="row">
    <!-- å·¦ä¾§ï¼šå‚æ•°é…ç½® -->
    <div class="col-lg-4 mb-4">
        <div class="config-card card h-100">
            <div class="card-header bg-white fw-bold py-3 border-0">
                <i class="fa-solid fa-gear me-2" style="color: #4facfe;"></i>äº¤äº’å‚æ•°
            </div>
            <div class="card-body">
                
                <!-- 1. æ‰“å¡æ¨¡å— -->
                <div class="config-section">
                    <div class="section-title text-primary"><i class="fa-solid fa-check-circle me-1"></i> æ‰“å¡è®¾ç½®</div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="checkin_open" {{ 'checked' if conf.checkin_open }}>
                        <label class="fw-bold">å¼€å¯æ‰“å¡åŠŸèƒ½</label>
                    </div>
                    
                    <div class="mb-3">
                        <label class="small text-muted fw-bold">è§¦å‘æŒ‡ä»¤ (é€—å·åˆ†éš”)</label>
                        <input id="checkin_cmd" class="form-control" value="{{ conf.checkin_cmd }}" placeholder="æ‰“å¡, ä¸Šç­">
                    </div>
                    
                    <div class="mb-0">
                        <label class="small text-muted fw-bold">å›å¤è‡ªåŠ¨åˆ é™¤ (ç§’)</label>
                        <input type="number" id="checkin_del_time" class="form-control" value="{{ conf.checkin_del_time }}">
                        <div class="form-text" style="font-size: 11px;">"æ‰“å¡æˆåŠŸ"æç¤ºå¤šä¹…æ¶ˆå¤±ã€‚</div>
                    </div>
                </div>
                
                <!-- 2. æŸ¥è¯¢æ¨¡å— -->
                <div class="config-section">
                    <div class="section-title text-info"><i class="fa-solid fa-search me-1"></i> æŸ¥è¯¢è®¾ç½®</div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="query_open" {{ 'checked' if conf.query_open }}>
                        <label class="fw-bold">å¼€å¯æ™®é€šæŸ¥è¯¢</label>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted fw-bold">æ™®é€šæŸ¥è¯¢æŒ‡ä»¤</label>
                        <input id="query_cmd" class="form-control" value="{{ conf.query_cmd }}" placeholder="æŸ¥è¯¢">
                    </div>

                    <hr class="my-3 text-muted">

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="query_filter_open" {{ 'checked' if conf.query_filter_open }}>
                        <label class="fw-bold">å¼€å¯å…³é”®è¯ç­›é€‰</label>
                    </div>
                    <div class="mb-3">
                        <div class="form-text small text-muted">æ”¯æŒ "æŒ‡ä»¤+å…³é”®è¯" æˆ– "ç›´æ¥æœå…³é”®è¯"</div>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="small text-muted fw-bold">æ¯é¡µè¡Œæ•°</label>
                            <input type="number" id="page_size" class="form-control" value="{{ conf.page_size }}">
                        </div>
                        <div class="col-6">
                            <label class="small text-muted fw-bold text-danger">åˆ—è¡¨åˆ é™¤(ç§’)</label>
                            <input type="number" id="query_del_time" class="form-control" value="{{ conf.query_del_time }}">
                        </div>
                    </div>
                    <div class="form-text" style="font-size: 11px;">æŸ¥è¯¢ç»“æœåˆ—è¡¨å¤šä¹…æ¶ˆå¤±ã€‚</div>
                </div>

                <!-- 3. å…¶ä»–è®¾ç½® -->
                <div class="config-section">
                    <div class="section-title"><i class="fa-solid fa-cog me-1"></i> å…¶ä»–</div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="small text-muted fw-bold">è‡ªåŠ¨ç‚¹èµ (å¼ºåˆ¶)</label>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="auto_like" {{ 'checked' if conf.auto_like }}>
                        </div>
                    </div>
                    <input id="like_emoji" class="form-control mb-3" value="{{ conf.like_emoji }}" placeholder="â¤ï¸">
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="auto_mute_expired" {{ 'checked' if conf.auto_mute_expired }}>
                        <label class="small text-danger fw-bold">è¿‡æœŸè‡ªåŠ¨ç¦è¨€</label>
                    </div>
                    
                    <label class="small text-muted fw-bold text-success">æ¨é€é¢‘é“ ID</label>
                    <input id="push_channel_id" class="form-control" value="{{ conf.push_channel_id or '' }}" placeholder="-100xxxxxxx">
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæ–‡æ¡ˆä¸æŒ‰é’® -->
    <div class="col-lg-8 mb-4">
        <!-- æ–‡æ¡ˆç¼–è¾‘å™¨ -->
        <div class="config-card card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-0">
                <span class="fw-bold"><i class="fa-solid fa-pen-to-square me-2" style="color: #4facfe;"></i>æ–‡æ¡ˆä¸æ¨¡æ¿</span>
                <select class="template-selector form-select w-auto" id="msgSelector" onchange="loadMsg()">
                    <option value="template">ğŸ‘¤ åˆ—è¡¨å•è¡Œæ¨¡æ¿</option>
                    <option value="msg_query_header">ğŸ“ æ™®é€šæŸ¥è¯¢æŠ¬å¤´</option>
                    <option value="msg_filter_header">ğŸ” ç­›é€‰æŸ¥è¯¢æŠ¬å¤´</option>
                    <option value="msg_expired_ban">â›”ï¸ è¿‡æœŸç¦è¨€æç¤º</option>
                    <option value="push_template">ğŸ“¢ é¢‘é“æ¨é€æ¨¡æ¿</option>
                    <option value="msg_checkin_success">âœ… æ‰“å¡æˆåŠŸæ¶ˆæ¯</option>
                    <option value="msg_not_registered">âš ï¸ æœªè®¤è¯æç¤º</option>
                    <option value="msg_repeat_checkin">ğŸ”„ é‡å¤æ‰“å¡æç¤º</option>
                </select>
            </div>
            <div class="card-body p-0">
                <!-- å·¥å…·æ  -->
                <div class="editor-toolbar d-flex flex-wrap gap-2 align-items-center">
                    <div class="btn-group rounded shadow-sm">
                        <button class="btn-toolbar-action" onclick="cmd('bold')" title="åŠ ç²—"><i class="fa-solid fa-bold"></i></button>
                        <button class="btn-toolbar-action" onclick="cmd('italic')" title="æ–œä½“"><i class="fa-solid fa-italic"></i></button>
                        <button class="btn-toolbar-action" onclick="cmd('underline')" title="ä¸‹åˆ’çº¿"><i class="fa-solid fa-underline"></i></button>
                        <button class="btn-toolbar-action" onclick="cmd('strikethrough')" title="åˆ é™¤çº¿"><i class="fa-solid fa-strikethrough"></i></button>
                    </div>
                    <div class="btn-group rounded shadow-sm">
                         <button class="btn-toolbar-action" onclick="cmd('insertUnorderedList')" title="åˆ—è¡¨"><i class="fa-solid fa-list-ul"></i></button>
                         <button class="btn-toolbar-action" onclick="link()" title="æ·»åŠ é“¾æ¥"><i class="fa-solid fa-link"></i></button>
                         <button class="btn-toolbar-action" onclick="cmd('unlink')" title="æ–­å¼€é“¾æ¥"><i class="fa-solid fa-unlink"></i></button>
                         <button class="btn-toolbar-action" onclick="cmd('removeFormat')" title="æ¸…é™¤æ ¼å¼"><i class="fa-solid fa-eraser"></i></button>
                    </div>
                    <div class="vr mx-1"></div>
                    <span class="badge-variable badge bg-light text-dark border" onmousedown="insert('{onlineEmoji}', event)">ğŸŸ¢è¡¨æƒ…</span>
                    <span class="badge-variable badge bg-info text-white border" onmousedown="insert('{åºå·}', event)">#ï¸âƒ£åºå·</span>
                    {% for f in fields %}
                    <span class="badge-variable badge bg-primary text-white border" onmousedown="insert('{'+'{{ f.label }}'+'}', event)">{{ f.label }}</span>
                    {% endfor %}
                    <span class="badge-variable badge bg-warning text-dark border" onmousedown="insert('{tg_id}', event)">TG_ID</span>
                </div>
                
                <div id="editor" class="editor-content" contenteditable="true"></div>
                
                <div class="p-3 border-top bg-light text-end">
                    <button class="btn btn-secondary" onclick="saveTmp()">
                        <i class="fa-solid fa-bookmark me-2"></i>æš‚å­˜å½“å‰æ–‡æ¡ˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- è‡ªå®šä¹‰æŒ‰é’® -->
        <div class="config-card card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-0">
                <span class="fw-bold"><i class="fa-solid fa-square-plus me-2" style="color: #4facfe;"></i>è‡ªå®šä¹‰æŒ‰é’® (åˆ—è¡¨åº•éƒ¨)</span>
                <button class="btn btn-outline-primary" onclick="addBtn()">
                    <i class="fa-solid fa-plus me-2"></i>æ·»åŠ æŒ‰é’®
                </button>
            </div>
            <div class="card-body">
                <div id="btnContainer" class="row g-2"></div>
                <textarea id="custom_buttons" class="form-control d-none">{{ conf.custom_buttons }}</textarea>
            </div>
        </div>
    </div>
</div>

<script>
    let msgs = {
        template: `{{ conf.template|safe }}`,
        push_template: `{{ conf.push_template|safe }}`,
        msg_checkin_success: `{{ conf.msg_checkin_success|safe }}`,
        msg_not_registered: `{{ conf.msg_not_registered|safe }}`,
        msg_repeat_checkin: `{{ conf.msg_repeat_checkin|safe }}`,
        msg_query_header: `{{ conf.msg_query_header|safe }}`,
        msg_filter_header: `{{ conf.msg_filter_header|safe }}`,
        msg_expired_ban: `{{ conf.msg_expired_ban|safe }}`
    };
    
    const currentGroupId = {{ group.id }};
    let btnData = [];
    try { btnData = JSON.parse(document.getElementById('custom_buttons').value || '[]'); } catch(e){}

    document.addEventListener('DOMContentLoaded', () => { loadMsg(); renderBtns(); });

    function renderBtns() {
        const con = document.getElementById('btnContainer');
        con.innerHTML = '';
        btnData.forEach((b, i) => {
            con.innerHTML += `
                <div class="col-md-6">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" placeholder="æŒ‰é’®æ–‡å­—" value="${b.text}" onchange="updateBtn(${i}, 'text', this.value)">
                        <input type="text" class="form-control" placeholder="è·³è½¬é“¾æ¥" value="${b.url}" onchange="updateBtn(${i}, 'url', this.value)">
                        <button class="btn btn-outline-danger" onclick="delBtn(${i})">Ã—</button>
                    </div>
                </div>
            `;
        });
        if(btnData.length === 0) con.innerHTML = '<div class="text-muted small text-center w-100 my-2">æš‚æ— æŒ‰é’®ï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ </div>';
    }
    
    function addBtn() { btnData.push({text:'', url:''}); renderBtns(); }
    function delBtn(i) { btnData.splice(i, 1); renderBtns(); }
    function updateBtn(i, key, val) { btnData[i][key] = val; }

    function loadMsg() { 
        if(!msgs.msg_filter_header) msgs.msg_filter_header = "ğŸ” <b>ç­›é€‰ç»“æœï¼š</b>\n";
        document.getElementById('editor').innerHTML = msgs[document.getElementById('msgSelector').value] || ''; 
    }
    
    function saveTmp() { 
        let content = document.getElementById('editor').innerHTML;
        content = content.replace(/&nbsp;/g, ' '); 
        msgs[document.getElementById('msgSelector').value] = content;
        const btn = document.querySelector('.btn-secondary');
        btn.innerHTML = 'å·²æš‚å­˜'; setTimeout(() => btn.innerHTML = 'æš‚å­˜', 500);
    }
    
    function cmd(c,v){ document.getElementById('editor').focus(); document.execCommand(c,false,v); }
    
    function insert(text, e) {
        e.preventDefault();
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            range.deleteContents();
            const textNode = document.createTextNode(text);
            range.insertNode(textNode);
            range.setStartAfter(textNode);
            range.setEndAfter(textNode);
            sel.removeAllRanges();
            sel.addRange(range);
        } else {
             document.getElementById('editor').focus();
             cmd('insertText', text);
        }
    }
    
    function link(){ let u=prompt('URL:'); if(u) cmd('createLink',u); }
    
    function saveSettings() {
        saveTmp(); 
        const d = {
            group_id: currentGroupId,
            config: {
                ...msgs,
                checkin_open: document.getElementById('checkin_open').checked,
                checkin_cmd: document.getElementById('checkin_cmd').value,
                checkin_del_time: document.getElementById('checkin_del_time').value, // æ‰“å¡åˆ é™¤
                
                query_open: document.getElementById('query_open').checked,
                query_cmd: document.getElementById('query_cmd').value,
                query_filter_open: document.getElementById('query_filter_open').checked,
                query_del_time: document.getElementById('query_del_time').value, // æŸ¥è¯¢åˆ é™¤
                
                page_size: document.getElementById('page_size').value,
                
                auto_like: document.getElementById('auto_like').checked,
                like_emoji: document.getElementById('like_emoji').value,
                auto_mute_expired: document.getElementById('auto_mute_expired').checked,

                push_channel_id: document.getElementById('push_channel_id').value,
                custom_buttons: JSON.stringify(btnData.filter(b => b.text && b.url)), 
                online_emoji: "{{ conf.online_emoji }}", 
                offline_emoji: "{{ conf.offline_emoji }}"
            }
        };
        fetch('/core/api/save_settings', {
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)
        }).then(()=>alert('âœ… é…ç½®å·²ä¿å­˜'));
    }
</script>
{% endblock %}
