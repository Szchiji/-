{% extends "base.html" %}
{% block content %}
<h2>功能配置</h2>
<button class="btn btn-primary mb-3" onclick="save()">保存所有</button>

<div class="row">
    <div class="col-md-6">
        <h4>参数</h4>
        <div class="form-group"><label>开启打卡</label><input type="checkbox" id="checkin_open" {{ 'checked' if conf.checkin_open }}></div>
        <div class="form-group"><label>打卡指令</label><input class="form-control" id="checkin_cmd" value="{{ conf.checkin_cmd }}"></div>
        <div class="form-group"><label>开启查询</label><input type="checkbox" id="query_open" {{ 'checked' if conf.query_open }}></div>
        <div class="form-group"><label>查询指令</label><input class="form-control" id="query_cmd" value="{{ conf.query_cmd }}"></div>
        <div class="form-group"><label>关键词搜索</label><input type="checkbox" id="query_filter_open" {{ 'checked' if conf.query_filter_open }}></div>
        <div class="form-group"><label>自动点赞</label><input type="checkbox" id="auto_like" {{ 'checked' if conf.auto_like }}></div>
        <div class="form-group"><label>点赞表情</label><input class="form-control" id="like_emoji" value="{{ conf.like_emoji }}"></div>
        <div class="form-group"><label>过期禁言</label><input type="checkbox" id="auto_mute_expired" {{ 'checked' if conf.auto_mute_expired }}></div>
        <div class="form-group"><label>推送频道ID</label><input class="form-control" id="push_channel_id" value="{{ conf.push_channel_id }}"></div>
    </div>
    <div class="col-md-6">
        <h4>文案模板 (HTML)</h4>
        <select class="form-control mb-2" id="sel" onchange="loadMsg()">
            <option value="template">列表行模板</option>
            <option value="msg_checkin_success">打卡成功</option>
            <option value="msg_not_registered">未认证</option>
            <option value="msg_repeat_checkin">重复打卡</option>
            <option value="push_template">推送模板</option>
        </select>
        <textarea class="form-control mb-2" id="editor" rows="10"></textarea>
        <button class="btn btn-secondary btn-sm" onclick="saveTmp()">暂存文案</button>
        
        <h4 class="mt-4">自定义按钮</h4>
        <div id="btns"></div>
        <button class="btn btn-sm btn-info" onclick="addBtn()">+ 按钮</button>
    </div>
</div>

<script>
let msgs={template:`{{ conf.template|safe }}`, push_template:`{{ conf.push_template|safe }}`, msg_checkin_success:`{{ conf.msg_checkin_success|safe }}`, msg_not_registered:`{{ conf.msg_not_registered|safe }}`, msg_repeat_checkin:`{{ conf.msg_repeat_checkin|safe }}`};
let btns=[]; try{btns=JSON.parse(`{{ conf.custom_buttons|safe }}`)||[];}catch(e){}

function renderBtns(){
    $('#btns').html(btns.map((b,i)=>`<div class="input-group mb-2"><input class="form-control" placeholder="文" value="${b.text}" onchange="btns[${i}].text=this.value"><input class="form-control" placeholder="链" value="${b.url}" onchange="btns[${i}].url=this.value"><div class="input-group-append"><button class="btn btn-danger" onclick="btns.splice(${i},1);renderBtns()">X</button></div></div>`).join(''));
}
function addBtn(){ btns.push({text:'',url:''}); renderBtns(); }
function loadMsg(){ $('#editor').val(msgs[$('#sel').val()]||''); }
function saveTmp(){ msgs[$('#sel').val()]=$('#editor').val(); alert('已暂存'); }

async function save(){
    saveTmp();
    let d={
        group_id:{{ group.id }},
        config:{
            ...msgs,
            checkin_open:$('#checkin_open').is(':checked'), checkin_cmd:$('#checkin_cmd').val(),
            query_open:$('#query_open').is(':checked'), query_cmd:$('#query_cmd').val(), query_filter_open:$('#query_filter_open').is(':checked'),
            auto_like:$('#auto_like').is(':checked'), like_emoji:$('#like_emoji').val(), auto_mute_expired:$('#auto_mute_expired').is(':checked'),
            push_channel_id:$('#push_channel_id').val(), custom_buttons:JSON.stringify(btns)
        }
    };
    await postApi('/core/api/save_settings', d);
}
$(()=>{loadMsg();renderBtns();});
</script>
{% endblock %}
