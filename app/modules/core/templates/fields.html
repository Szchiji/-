{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">字段配置</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-primary" onclick="saveFields()">保存配置</button>
    </div>
</div>

<div class="alert alert-info">
    配置用户需要录入的资料项。Key 必须是英文，Label 是显示名称。
</div>

<div id="fields-container"></div>
<button class="btn btn-outline-secondary mt-3" onclick="addField()">+ 添加新字段</button>

<script>
    let currentFields = {{ fields_json | safe }} || [];
    if(!Array.isArray(currentFields)) currentFields = [];

    function render() {
        let html = '';
        currentFields.forEach((f, idx) => {
            html += `
            <div class="row mb-3 border-bottom pb-3">
                <div class="col-md-3">
                    <label>Key (英文)</label>
                    <input type="text" class="form-control" value="${f.key||''}" onchange="upd(${idx},'key',this.value)">
                </div>
                <div class="col-md-3">
                    <label>显示名称</label>
                    <input type="text" class="form-control" value="${f.label||''}" onchange="upd(${idx},'label',this.value)">
                </div>
                <div class="col-md-2">
                    <label>类型</label>
                    <select class="form-control" onchange="upd(${idx},'type',this.value)">
                        <option value="text" ${f.type=='text'?'selected':''}>文本</option>
                        <option value="select" ${f.type=='select'?'selected':''}>下拉菜单</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>选项 (逗号隔开)</label>
                    <input type="text" class="form-control" value="${f.options||''}" onchange="upd(${idx},'options',this.value)" ${f.type!='select'?'disabled':''}>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-danger" onclick="rem(${idx})">删除</button>
                </div>
            </div>
            `;
        });
        $('#fields-container').html(html);
    }

    function addField() {
        currentFields.push({key: '', label: '', type: 'text', options: ''});
        render();
    }
    function rem(i) {
        currentFields.splice(i, 1);
        render();
    }
    function upd(i, k, v) {
        currentFields[i][k] = v;
        if(k === 'type') render();
    }
    async function saveFields() {
        await postApi('/core/api/save_fields', {fields: currentFields});
    }
    
    render();
</script>
{% endblock %}
