{% extends "base.html" %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center bg-white">
        <h6 class="m-0 font-weight-bold text-primary">字段配置</h6>
        <button class="btn btn-outline-primary btn-sm" onclick="saveFields()">
            <i class="fa-solid fa-save me-1"></i> 保存更改
        </button>
    </div>
    <div class="card-body">
        <div id="fields-container"></div>
        <button class="btn btn-light w-100 mt-3 border-dashed py-3 text-primary fw-bold" onclick="addField()" style="border: 2px dashed #e3e6f0;">
            <i class="fa-solid fa-plus me-2"></i> 添加新字段
        </button>
    </div>
</div>

<script>
    // ⚡️ 修复：确保默认是数组，防止报错
    let currentFields = {{ fields_json | safe }} || [];
    if (!Array.isArray(currentFields)) currentFields = [];

    function render() {
        let html = '';
        currentFields.forEach((f, idx) => {
            html += `
            <div class="row g-2 align-items-center mb-3 pb-3 border-bottom field-item">
                <div class="col-md-3">
                    <label class="small text-muted fw-bold">字段键名 (Key)</label>
                    <input type="text" class="form-control bg-light" value="${f.key || ''}" onchange="updateField(${idx}, 'key', this.value)" placeholder="如: age">
                </div>
                <div class="col-md-3">
                    <label class="small text-muted fw-bold">显示名称 (Label)</label>
                    <input type="text" class="form-control fw-bold" value="${f.label || ''}" onchange="updateField(${idx}, 'label', this.value)" placeholder="如: 年龄">
                </div>
                <div class="col-md-2">
                    <label class="small text-muted fw-bold">类型</label>
                    <select class="form-select" onchange="updateField(${idx}, 'type', this.value)">
                        <option value="text" ${f.type=='text'?'selected':''}>文本</option>
                        <option value="select" ${f.type=='select'?'selected':''}>下拉菜单</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small text-muted fw-bold">选项 (逗号分隔)</label>
                    <input type="text" class="form-control" value="${f.options||''}" onchange="updateField(${idx}, 'options', this.value)" ${f.type!='select'?'disabled':''} placeholder="A,B,C">
                </div>
                <div class="col-md-1 text-center pt-4">
                    <button class="btn btn-link text-danger" onclick="removeField(${idx})"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>`;
        });
        if (currentFields.length === 0) {
            html = '<div class="text-center text-muted py-4">暂无字段，请点击下方按钮添加。</div>';
        }
        $('#fields-container').html(html);
    }
    
    function addField() { 
        currentFields.push({key: '', label: '', type: 'text', options: ''}); 
        render(); 
    }
    
    function removeField(idx) { 
        currentFields.splice(idx, 1); 
        render(); 
    }
    
    function updateField(idx, key, val) { 
        currentFields[idx][key] = val; 
        if(key === 'type') render(); 
    }
    
    async function saveFields() { 
        await postApi('/core/api/save_fields', {fields: currentFields}); 
    }
    
    // 确保 DOM 加载完成后渲染
    $(document).ready(function() {
        render();
    });
</script>
{% endblock %}
