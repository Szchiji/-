{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0">字段配置 ({{ group.title }})</h4>
    <button class="btn btn-primary fw-bold px-4" onclick="saveFields()"><i class="fa-solid fa-save me-2"></i>保存</button>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body">
        <div id="fields-con"></div>
        <button class="btn btn-outline-primary w-100 mt-3 border-2 border-dashed" onclick="addField()">
            <i class="fa-solid fa-plus me-1"></i> 添加新字段
        </button>
    </div>
</div>

<script>
    let fields = {{ fields_json|safe }};
    const container = document.getElementById('fields-con');

    function render() {
        container.innerHTML = '';
        fields.forEach((f, i) => {
            container.innerHTML += `
            <div class="row g-2 align-items-center mb-3 bg-light p-3 rounded border">
                <div class="col-md-3">
                    <label class="small text-muted">字段名 (key)</label>
                    <input class="form-control form-control-sm" value="${f.key}" oninput="fields[${i}].key=this.value" placeholder="英文,如 region">
                </div>
                <div class="col-md-3">
                    <label class="small text-muted">显示名 (label)</label>
                    <input class="form-control form-control-sm" value="${f.label}" oninput="fields[${i}].label=this.value" placeholder="中文,如 地区">
                </div>
                <div class="col-md-3">
                    <label class="small text-muted">类型</label>
                    <select class="form-select form-select-sm" onchange="fields[${i}].type=this.value; render()">
                        <option value="text" ${f.type=='text'?'selected':''}>文本</option>
                        <option value="select" ${f.type=='select'?'selected':''}>下拉菜单</option>
                    </select>
                </div>
                <div class="col-md-2">
                    ${f.type==='select' ? `<label class="small text-muted">选项 (逗号隔开)</label><input class="form-control form-control-sm" value="${(f.options||[]).join(',')}" oninput="fields[${i}].options=this.value.split(',')">` : ''}
                </div>
                <div class="col-md-1 text-end">
                    <button class="btn btn-sm btn-outline-danger mt-4" onclick="fields.splice(${i},1);render()"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>`;
        });
    }

    function addField() { fields.push({key:'', label:'', type:'text'}); render(); }
    
    function saveFields() {
        // 直接传 fields 列表
        fetch('/core/api/save_fields', {
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify(fields) 
        }).then(()=>alert('✅ 字段配置已保存'));
    }

    render();
</script>
{% endblock %}
