{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    <h3 class="fw-bold mb-4 text-center">选择管理的群组</h3>
    <div class="row g-4 justify-content-center">
        {% for g in groups %}
        <div class="col-md-6 col-lg-4" id="card_{{ g.id }}">
            <div class="card h-100 shadow-sm border-0 {{ 'bg-light' if not g.is_active else '' }}">
                <div class="card-body text-center">
                    <h5 class="card-title fw-bold text-truncate" title="{{ g.title }}">
                        {% if not g.is_active %}
                            <span class="badge bg-secondary me-1">停用</span>
                        {% endif %}
                        {{ g.title }}
                    </h5>
                    <p class="text-muted small mb-3">ID: {{ g.chat_id }}</p>
                    <p class="text-muted small">上次活跃: {{ g.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    
                    <div class="d-grid gap-2">
                        <a href="/core/group/{{ g.id }}/dashboard" class="btn btn-primary fw-bold">进入管理</a>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-sm btn-outline-{% if g.is_active %}warning{% else %}success{% endif %} w-100" onclick="toggleGroup({{ g.id }}, {{ 'true' if g.is_active else 'false' }})">
                                <i class="fa-solid fa-toggle-{% if g.is_active %}on{% else %}off{% endif %}"></i> {% if g.is_active %}停用{% else %}启用{% endif %}
                            </button>
                            <button class="btn btn-sm btn-outline-danger w-100" onclick="deleteGroup({{ g.id }})">
                                <i class="fa-solid fa-trash"></i> 删除记录
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center text-muted">
            <div class="py-5">
                <i class="fa-brands fa-telegram fa-3x mb-3"></i>
                <p>暂无群组，请将机器人拉入群组并设为管理员</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function toggleGroup(gid, isActive) {
        const action = isActive ? '停用' : '启用';
        if(!confirm(`确定要${action}这个群组吗？\n${isActive ? '停用后机器人将不再响应该群组的消息。' : '启用后机器人将恢复响应该群组的消息。'}`)) return;
        
        fetch('/core/api/toggle_group', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: gid, action: 'toggle'})
        }).then(res => res.json()).then(data => {
            if(data.status === 'ok') {
                location.reload();
            } else {
                alert('操作失败');
            }
        });
    }
    
    function deleteGroup(gid) {
        if(!confirm('确定要在后台删除这个群组吗？\n如果机器人还在群里，下次说话时它会重新出现。')) return;
        
        fetch('/core/api/toggle_group', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: gid, action: 'delete'})
        }).then(res => res.json()).then(data => {
            if(data.status === 'ok') {
                document.getElementById('card_' + gid).remove();
            } else {
                alert('操作失败');
            }
        });
    }
</script>
{% endblock %}
