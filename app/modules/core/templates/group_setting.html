{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold mb-1"><i class="fa-solid fa-users-gear me-2"></i>{{ group.title }}</h4>
        <p class="text-muted mb-0 small">æ­£åœ¨é…ç½®ç¾¤ç»„ ID: {{ group.chat_id }} | <span class="text-info">ç•™ç©ºåˆ™ä½¿ç”¨å…¨å±€é»˜è®¤å€¼</span></p>
    </div>
    <a href="/core/dashboard" class="btn btn-outline-secondary"><i class="fa-solid fa-arrow-left me-1"></i> è¿”å›åˆ—è¡¨</a>
</div>

<div class="row">
    <!-- æ‰“å¡ç‹¬ç«‹é…ç½® -->
    <div class="col-md-6 mb-4">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white fw-bold py-3 text-primary">æ‰“å¡é…ç½® (ç‹¬ç«‹)</div>
            <div class="card-body">
                <div class="form-check form-switch mb-3 p-2 bg-light rounded">
                    <input class="form-check-input ms-0 me-2" type="checkbox" id="checkin_open" {{ 'checked' if g_conf.get('checkin_open', sys.checkin_open) }}>
                    <label class="fw-bold">å¼€å¯æœ¬ç¾¤æ‰“å¡</label>
                </div>
                <div class="mb-3">
                    <label class="small text-muted">æœ¬ç¾¤æ‰“å¡æŒ‡ä»¤ (é»˜è®¤: {{ sys.checkin_cmd }})</label>
                    <input id="checkin_cmd" class="form-control" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤..." value="{{ g_conf.get('checkin_cmd', '') }}">
                </div>
                
                <label class="small text-muted fw-bold mb-2">æœ¬ç¾¤æ–‡æ¡ˆ (ç‚¹å‡»ä¿®æ”¹)</label>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-light border text-start text-truncate" onclick="openEditor('msg_checkin_success','æ‰“å¡æˆåŠŸ')">
                        âœ… æˆåŠŸ: {{ g_conf.get('msg_checkin_success') or 'é»˜è®¤å€¼' }}
                    </button>
                    <button class="btn btn-light border text-start text-truncate" onclick="openEditor('msg_not_registered','æœªè®¤è¯')">
                        âš ï¸ æœªè®¤è¯: {{ g_conf.get('msg_not_registered') or 'é»˜è®¤å€¼' }}
                    </button>
                    <button class="btn btn-light border text-start text-truncate" onclick="openEditor('msg_repeat_checkin','é‡å¤æ‰“å¡')">
                        ğŸ”„ é‡å¤: {{ g_conf.get('msg_repeat_checkin') or 'é»˜è®¤å€¼' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŸ¥è¯¢ç‹¬ç«‹é…ç½® -->
    <div class="col-md-6 mb-4">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-white fw-bold py-3 text-success">æŸ¥è¯¢é…ç½® (ç‹¬ç«‹)</div>
            <div class="card-body">
                <div class="form-check form-switch mb-3 p-2 bg-light rounded">
                    <input class="form-check-input ms-0 me-2" type="checkbox" id="query_open" {{ 'checked' if g_conf.get('query_open', sys.query_open) }}>
                    <label class="fw-bold">å¼€å¯æœ¬ç¾¤æŸ¥è¯¢</label>
                </div>
                <div class="mb-3">
                    <label class="small text-muted">æœ¬ç¾¤æŸ¥è¯¢æŒ‡ä»¤ (é»˜è®¤: {{ sys.query_cmd }})</label>
                    <input id="query_cmd" class="form-control" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤..." value="{{ g_conf.get('query_cmd', '') }}">
                </div>
                
                <label class="small text-muted fw-bold mb-2">æœ¬ç¾¤æ¨¡æ¿ (ç‚¹å‡»ä¿®æ”¹)</label>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-light border text-start text-truncate" onclick="openEditor('msg_query_header','åˆ—è¡¨æŠ¬å¤´')">
                        ğŸ“ æŠ¬å¤´: {{ g_conf.get('msg_query_header') or 'é»˜è®¤å€¼' }}
                    </button>
                    <button class="btn btn-light border text-start text-truncate" onclick="openEditor('template','ç”¨æˆ·æ¨¡æ¿')">
                        ğŸ‘¤ æ¨¡æ¿: {{ g_conf.get('template') or 'é»˜è®¤å€¼' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<button class="btn btn-primary w-100 fw-bold mb-5 shadow" onclick="saveGroup()">
    <i class="fa-solid fa-save me-2"></i>ä¿å­˜æœ¬ç¾¤è®¾ç½®
</button>

<!-- å¼¹çª—ç¼–è¾‘å™¨ (å¤ç”¨) -->
<div class="modal fade" id="editorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
        <div class="modal-header py-2"><h6 class="modal-title fw-bold">ç¼–è¾‘</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body p-0">
            <div class="p-3 border-bottom bg-light d-flex flex-wrap gap-2">
                <span class="text-muted fw-bold">å˜é‡:</span>
                <span class="cursor-pointer text-primary" onclick="insert('{onlineEmoji}')">è¡¨æƒ…</span>
                {% for f in fields %}<span class="cursor-pointer text-primary" onclick="insert('{'+'{{ f.label }}'+'}')">{{ f.label }}</span>{% endfor %}
            </div>
            <div id="richEditor" class="p-3" contenteditable="true" style="min-height:200px;outline:none"></div>
        </div>
        <div class="modal-footer py-2"><button class="btn btn-primary" onclick="saveEd()">ç¡®å®š</button></div>
    </div></div>
</div>

<!-- éšè—åŸŸå­˜å‚¨å½“å‰ç¾¤é…ç½® (å¦‚æœä¸ºç©ºåˆ™ç©º) -->
<div style="display:none">
    <textarea id="v_msg_checkin_success">{{ g_conf.get('msg_checkin_success', '') }}</textarea>
    <textarea id="v_msg_not_registered">{{ g_conf.get('msg_not_registered', '') }}</textarea>
    <textarea id="v_msg_repeat_checkin">{{ g_conf.get('msg_repeat_checkin', '') }}</textarea>
    <textarea id="v_msg_query_header">{{ g_conf.get('msg_query_header', '') }}</textarea>
    <textarea id="v_template">{{ g_conf.get('template', '') }}</textarea>
</div>

<script>
    let cur='', modal=null;
    document.addEventListener('DOMContentLoaded', ()=> modal = new bootstrap.Modal(document.getElementById('editorModal')));
    function openEditor(k,t){ cur=k; document.querySelector('.modal-title').innerText=t; document.getElementById('richEditor').innerHTML=document.getElementById('v_'+k).value; modal.show(); }
    function saveEd(){ document.getElementById('v_'+cur).value=document.getElementById('richEditor').innerHTML; modal.hide(); }
    function insert(t){ document.getElementById('richEditor').focus(); document.execCommand('insertText',false,t); }
    
    function saveGroup(){
        // è·å–æ‰€æœ‰å­—æ®µï¼Œå¦‚æœä¸ºç©ºå­—ç¬¦ä¸²åˆ™ä¼  null (åç«¯ä¸åšåˆå¹¶) æˆ–ä¿ç•™ä¸ºç©ºå­—ç¬¦ä¸²
        // è¿™é‡Œæˆ‘ä»¬ç­–ç•¥æ˜¯ï¼šå¦‚æœä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™è¡¨ç¤ºâ€œæœªè®¾ç½®â€ï¼Œåç«¯é€»è¾‘é‡Œä¸è¦†ç›–å…¨å±€ã€‚
        // ä½†ä¸ºäº†ç®€å•ï¼Œå‰ç«¯ä¼ ä»€ä¹ˆå­˜ä»€ä¹ˆã€‚
        const d = {
            id: {{ group.id }},
            config: {
                checkin_open: document.getElementById('checkin_open').checked,
                checkin_cmd: document.getElementById('checkin_cmd').value,
                query_open: document.getElementById('query_open').checked,
                query_cmd: document.getElementById('query_cmd').value,
                msg_checkin_success: document.getElementById('v_msg_checkin_success').value,
                msg_not_registered: document.getElementById('v_msg_not_registered').value,
                msg_repeat_checkin: document.getElementById('v_msg_repeat_checkin').value,
                msg_query_header: document.getElementById('v_msg_query_header').value,
                template: document.getElementById('v_template').value
            }
        };
        fetch('/core/api/save_group_config', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)})
        .then(()=>alert('âœ… ç¾¤ç»„ç‹¬ç«‹é…ç½®å·²ä¿å­˜ï¼'));
    }
</script>
<style>.cursor-pointer:hover{text-decoration:underline}</style>
{% endblock %}
