<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>阿福Bot Pro 后台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --sidebar-width: 260px; --primary-color: #5c6bc0; --bg-color: #f3f4f6; }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', sans-serif; display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: #fff; height: 100vh; position: fixed; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 100; overflow-y: auto; }
        .brand-section { padding: 25px 30px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; font-weight: 800; color: var(--primary-color); font-size: 1.4rem; }
        .nav-link { display: flex; align-items: center; padding: 12px 30px; color: #4b5563; text-decoration: none; font-weight: 500; }
        .nav-link:hover, .nav-link.active { color: var(--primary-color); background: #eef2ff; border-left: 4px solid var(--primary-color); }
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 30px; width: calc(100% - var(--sidebar-width)); }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); background: #fff; margin-bottom: 25px; }
        .card-header { background: #fff; border-bottom: 1px solid #f3f4f6; padding: 20px 25px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 25px; }
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f3f4f6; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .tag-badge { background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px; }
        /* 移动端 */
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .main-content { margin-left: 0; width: 100%; } }
    </style>
</head>
<body>
    {% if page == 'login' %}
    <div class="login-wrapper">
        <div class="card p-5 text-center shadow-lg" style="max-width: 400px;">
            <h3 class="mb-3 fw-bold">后台管理系统</h3>
            <p class="text-muted">请在 Telegram 发送 /start 获取登录链接</p>
        </div>
    </div>
    {% else %}
    <nav class="sidebar">
        <div class="brand-section"><i class="fa-solid fa-robot me-2"></i>阿福Bot Pro</div>
        <div class="small text-uppercase text-muted fw-bold px-4 mb-2">菜单</div>
        <a href="/users" class="nav-link {{ 'active' if page == 'users' else '' }}"><i class="fa-solid fa-users me-3"></i>用户列表</a>
        <a href="/fields" class="nav-link {{ 'active' if page == 'fields' else '' }}"><i class="fa-solid fa-list-check me-3"></i>字段配置</a>
        <a href="/template" class="nav-link {{ 'active' if page == 'template' else '' }}"><i class="fa-solid fa-file-alt me-3"></i>消息模板</a>
        <a href="/system" class="nav-link {{ 'active' if page == 'system' else '' }}"><i class="fa-solid fa-sliders me-3"></i>系统设置</a>
        <div class="mt-auto p-4"><a href="/logout" class="btn btn-outline-danger w-100">退出</a></div>
    </nav>

    <main class="main-content">
        <!-- 用户列表 -->
        {% if page == 'users' %}
        <div class="d-flex justify-content-between mb-4">
            <h4>认证用户列表</h4>
            <div class="d-flex gap-2">
                <input class="form-control" placeholder="搜索..." value="{{ q }}" onchange="location.href='?q='+this.value">
                <button class="btn btn-primary" onclick="openUserModal()">+ 添加</button>
            </div>
        </div>
        <div class="card">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light"><tr><th class="ps-4">TG ID</th><th>预览</th><th>状态</th><th class="text-end pe-4">操作</th></tr></thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td class="ps-4">{{ u.tg_id }}</td>
                        <td>
                            {% set d = u.profile_data|from_json %}
                            {% for k,v in d.items() %}
                                {% if v and loop.index <= 4 %}<span class="badge bg-light text-dark border me-1">{{ v }}</span>{% endif %}
                            {% endfor %}
                        </td>
                        <td>{% if u.online %}<span class="badge bg-success">在线</span>{% else %}<span class="badge bg-secondary">离线</span>{% endif %}</td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-info text-white" onclick="pushUser({{ u.id }})">推送</button>
                            <button class="btn btn-sm btn-outline-primary" onclick='editUser({{ u.tg_id }}, {{ u.profile_data|tojson }})'>编辑</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="delUser({{ u.id }})">删除</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 字段配置 -->
        {% elif page == 'fields' %}
        <div class="card">
            <div class="card-header">字段配置</div>
            <div class="card-body">
                <div id="fieldsCon"></div>
                <button class="btn btn-sm btn-outline-primary mt-3" onclick="addField()">+ 新增字段</button>
                <button class="btn btn-primary w-100 mt-3" onclick="saveFields()">保存配置</button>
            </div>
        </div>
        <script>
            let fieldsData = {{ fields_json|safe }};
            function renderFields() {
                const con = document.getElementById('fieldsCon'); con.innerHTML = '';
                fieldsData.forEach((f,i) => {
                    let optHtml = '';
                    if(f.type !== 'text') {
                        let tags = (f.options||[]).map(o=>`<span class="tag-badge">${o}<span style="cursor:pointer;margin-left:4px" onclick="delOpt(${i},'${o}')">&times;</span></span>`).join('');
                        optHtml = `<div class="mt-2 border p-2 rounded bg-light">${tags}<input class="border-0 bg-transparent outline-0 ms-2" placeholder="回车添加..." onkeydown="addOpt(event,${i})"></div>`;
                    }
                    con.innerHTML += `
                    <div class="row g-2 mb-3 border-bottom pb-3">
                        <div class="col-md-3"><input class="form-control" value="${f.label}" onchange="fieldsData[${i}].label=this.value" placeholder="名称"></div>
                        <div class="col-md-3"><input class="form-control" value="${f.key}" onchange="fieldsData[${i}].key=this.value" placeholder="Key"></div>
                        <div class="col-md-2">
                            <select class="form-select" onchange="fieldsData[${i}].type=this.value;renderFields()">
                                <option value="text" ${f.type=='text'?'selected':''}>文本</option>
                                <option value="select" ${f.type=='select'?'selected':''}>单选</option>
                                <option value="checkbox" ${f.type=='checkbox'?'selected':''}>多选</option>
                            </select>
                        </div>
                        <div class="col-md-3">${optHtml}</div>
                        <div class="col-md-1"><button class="btn btn-danger btn-sm" onclick="fieldsData.splice(${i},1);renderFields()">×</button></div>
                    </div>`;
                });
            }
            function addOpt(e,i){if(e.key==='Enter'){e.preventDefault();if(e.target.value){if(!fieldsData[i].options)fieldsData[i].options=[];fieldsData[i].options.push(e.target.value);renderFields();}}}
            function delOpt(i,v){fieldsData[i].options=fieldsData[i].options.filter(o=>o!==v);renderFields();}
            function addField(){fieldsData.push({key:'k'+Date.now(),label:'',type:'text'});renderFields();}
            function saveFields(){fetch('/api/save_fields',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(fieldsData)}).then(()=>alert('Saved'));}
            setTimeout(renderFields, 100);
        </script>

        <!-- 模板编辑 -->
        {% elif page == 'template' %}
        <div class="card">
            <div class="card-header">消息模板</div>
            <div class="card-body">
                <div class="mb-2">
                    <span class="badge bg-secondary cursor-pointer me-1" onclick="insertTxt('{onlineEmoji}')">在线表情</span>
                    {% for f in fields %}<span class="badge bg-info cursor-pointer me-1" onclick="insertTxt('{'+'{{ f.label }}'+'}')">{{ f.label }}</span>{% endfor %}
                </div>
                <textarea id="editor" class="form-control" rows="10">{{ template_str }}</textarea>
                <button class="btn btn-primary mt-3" onclick="saveTemplate()">保存模板</button>
            </div>
        </div>
        <script>
            function insertTxt(t){const el=document.getElementById('editor');el.setRangeText(t,el.selectionStart,el.selectionEnd,'end');el.focus();}
            function saveTemplate(){fetch('/api/save_template',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({template:document.getElementById('editor').value})}).then(()=>alert('Saved'));}
        </script>

        <!-- 系统设置 -->
        {% elif page == 'system' %}
        <div class="card">
            <div class="card-header">系统设置</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3"><label>打卡指令</label><input id="checkin_cmd" class="form-control" value="{{ sys.checkin_cmd }}"></div>
                    <div class="col-md-6 mb-3"><label>查询指令</label><input id="query_cmd" class="form-control" value="{{ sys.query_cmd }}"></div>
                    <div class="col-md-6 mb-3"><label>在线Emoji</label><input id="online_emoji" class="form-control" value="{{ sys.online_emoji }}"></div>
                    <div class="col-md-6 mb-3"><label>推送频道ID</label><input id="push_channel_id" class="form-control" value="{{ sys.push_channel_id }}"></div>
                    <div class="col-md-12 mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto_like" {{ 'checked' if sys.auto_like }}>
                            <label>自动点赞 (Emoji: <input id="like_emoji" style="width:50px;border:none;border-bottom:1px solid #ccc" value="{{ sys.like_emoji }}"> )</label>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveSystem()">保存设置</button>
            </div>
        </div>
        <script>
            function saveSystem(){
                const data = {
                    checkin_cmd: document.getElementById('checkin_cmd').value,
                    query_cmd: document.getElementById('query_cmd').value,
                    online_emoji: document.getElementById('online_emoji').value,
                    push_channel_id: document.getElementById('push_channel_id').value,
                    like_emoji: document.getElementById('like_emoji').value,
                    auto_like: document.getElementById('auto_like').checked,
                    checkin_open: true, query_open: true
                };
                fetch('/api/save_system',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(()=>alert('Saved'));
            }
        </script>
        {% endif %}
    </main>

    <!-- 用户弹窗 -->
    <div class="modal fade" id="userModal">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">用户资料</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="mb-3"><label>TG ID</label><input type="number" name="tg_id" class="form-control" required></div>
                    <div id="modalFields"></div>
                    <hr>
                    <div class="row"><div class="col"><label>加天数</label><input type="number" name="add_days" class="form-control" value="0"></div></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveUser()">保存</button></div>
        </div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% if page == 'users' %}
    <script>
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        const fields = {{ fields|tojson }};
        function renderUserFields(data) {
            const con = document.getElementById('modalFields'); con.innerHTML = '';
            fields.forEach(f => {
                let val = data[f.key] || '';
                let html = '';
                if(f.type==='select'){
                    let opts=(f.options||[]).map(o=>`<option value="${o}" ${o==val?'selected':''}>${o}</option>`).join('');
                    html=`<select name="${f.key}" class="form-select"><option value="">选一个</option>${opts}</select>`;
                } else if(f.type==='checkbox'){
                    html='<div>'; (f.options||[]).forEach(o=>{ let chk=val.includes(o)?'checked':''; html+=`<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" name="${f.key}" value="${o}" ${chk}><label class="form-check-label">${o}</label></div>`; }); html+='</div>';
                } else { html=`<input class="form-control" name="${f.key}" value="${val}">`; }
                con.innerHTML += `<div class="mb-3"><label>${f.label}</label>${html}</div>`;
            });
        }
        function openUserModal(){ document.getElementById('userForm').reset(); renderUserFields({}); modal.show(); }
        function editUser(tgId, data){ document.getElementById('userForm').reset(); document.querySelector('[name=tg_id]').value=tgId; renderUserFields(data); modal.show(); }
        function saveUser(){
            const fd = new FormData(document.getElementById('userForm'));
            const data = {tg_id: fd.get('tg_id'), add_days: fd.get('add_days'), profile:{}};
            fields.forEach(f=>{
                if(f.type==='checkbox'){ const v=[]; document.querySelectorAll(`[name="${f.key}"]:checked`).forEach(c=>v.push(c.value)); data.profile[f.key]=v.join(','); }
                else { data.profile[f.key]=fd.get(f.key); }
            });
            fetch('/api/save_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(()=>location.reload());
        }
        function delUser(id){ if(confirm('删除?')) fetch('/api/delete_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}).then(()=>location.reload()); }
        function pushUser(id){ if(confirm('推送?')) fetch('/api/push_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}).then(r=>r.json()).then(d=>alert(d.msg)); }
    </script>
    {% endif %}
    {% endif %}
</body>
</html>
