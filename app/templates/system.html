{% extends "base.html" %}
{% block content %}
<div class="row">
    <!-- 消息模板编辑器 -->
    <div class="col-lg-7 mb-4">
        <div class="card h-100">
            <div class="card-header"><span>消息模板 (查询/推送)</span></div>
            <div class="card-body">
                <div class="mb-2">
                    <span class="badge bg-info cursor-pointer mb-1 me-1" onclick="insertTxt('{onlineEmoji}')">在线表情</span>
                    {% for f in fields %}<span class="badge bg-secondary cursor-pointer me-1 mb-1" onclick="insertTxt('{'+'{{ f.label }}'+'}')">{{ f.label }}</span>{% endfor %}
                </div>
                <div class="editor-tb mb-2 rounded border">
                    <button class="btn btn-sm btn-light" onclick="execCmd('bold')"><b>B</b></button>
                    <button class="btn btn-sm btn-light" onclick="execCmd('italic')"><i>I</i></button>
                </div>
                <!-- 自定义编辑器 -->
                <div id="editor" class="editor-content border rounded" contenteditable="true"></div>
            </div>
        </div>
    </div>
    
    <!-- 系统开关 -->
    <div class="col-lg-5 mb-4">
        <div class="card">
            <div class="card-header">系统参数</div>
            <div class="card-body">
                <h6 class="text-muted small fw-bold mb-3">互动</h6>
                <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="auto_like" {{ 'checked' if sys.auto_like }}><label>自动点赞 (Emoji: <input id="like_emoji" style="width:40px;border:none;border-bottom:1px solid #ccc" value="{{ sys.like_emoji }}">)</label></div>
                <h6 class="text-muted small fw-bold mb-3">配置</h6>
                <div class="mb-3"><label class="small">推送频道ID</label><input id="push_channel_id" class="form-control" placeholder="-100xxxxxxx" value="{{ sys.push_channel_id }}"></div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="small">在线Emoji</label><input id="online_emoji" class="form-control" value="{{ sys.online_emoji }}"></div>
                    <div class="col-6"><label class="small">离线Emoji</label><input id="offline_emoji" class="form-control" value="{{ sys.offline_emoji }}"></div>
                </div>
                <button class="btn btn-primary w-100" onclick="saveSys()">保存设置</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 初始化编辑器内容
    document.getElementById('editor').innerHTML = `{{ template_str|safe }}`;
    
    function saveSys() {
        const data = {
            template: document.getElementById('editor').innerHTML,
            auto_like: document.getElementById('auto_like').checked,
            like_emoji: document.getElementById('like_emoji').value,
            push_channel_id: document.getElementById('push_channel_id').value,
            online_emoji: document.getElementById('online_emoji').value,
            offline_emoji: document.getElementById('offline_emoji').value,
            checkin_open: true, checkin_cmd: '/daka', query_open: true, query_cmd: '/online'
        };
        fetch('/api/save_system', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
        .then(()=>alert('设置已保存'));
    }
</script>
{% endblock %}
