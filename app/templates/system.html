{% extends "base.html" %}
{% block content %}
<div class="row">
    <!-- 消息模板编辑器 -->
    <div class="col-lg-7 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <span>消息模板 (查询/推送)</span>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-2">
                    <small class="text-muted d-block mb-2">点击插入变量：</small>
                    {% for f in fields %}
                    <span class="badge bg-secondary cursor-pointer me-1 mb-1" onclick="editor.insertVar('{'+'{{ f.label }}'+'}')">{{ f.label }}</span>
                    {% endfor %}
                    <span class="badge bg-info cursor-pointer mb-1" onclick="editor.insertVar('{onlineEmoji}')">在线表情</span>
                </div>
                
                <!-- 这里调用 editor.js 生成编辑器 -->
                <div id="editorCon" class="flex-grow-1 border rounded"></div>
            </div>
        </div>
    </div>
    
    <!-- 系统开关 -->
    <div class="col-lg-5 mb-4">
        <div class="card">
            <div class="card-header">系统参数</div>
            <div class="card-body">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">打卡与互动</h6>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="auto_like" {{ 'checked' if sys.auto_like }}>
                    <label class="form-check-label">自动点赞认证用户 (截图10)</label>
                </div>
                <div class="mb-3">
                    <label class="form-label small">点赞表情</label>
                    <input id="like_emoji" class="form-control" value="{{ sys.like_emoji }}">
                </div>
                
                <hr>
                
                <h6 class="text-uppercase text-muted small fw-bold mb-3">推送配置</h6>
                <div class="mb-3">
                    <label class="form-label small">推送目标频道ID</label>
                    <input id="push_channel_id" class="form-control" placeholder="-100xxxxxxx" value="{{ sys.push_channel_id }}">
                </div>
                
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label small">在线Emoji</label>
                        <input id="online_emoji" class="form-control" value="{{ sys.online_emoji }}">
                    </div>
                    <div class="col-6">
                        <label class="form-label small">离线Emoji</label>
                        <input id="offline_emoji" class="form-control" value="{{ sys.offline_emoji }}">
                    </div>
                </div>

                <button class="btn btn-primary w-100 mt-4" onclick="saveSys()">保存设置</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 初始化编辑器
    const editor = new CustomEditor('editorCon', `{{ sys.template|safe }}`);
    
    function saveSys() {
        const data = {
            template: editor.getValue(),
            auto_like: document.getElementById('auto_like').checked,
            like_emoji: document.getElementById('like_emoji').value,
            push_channel_id: document.getElementById('push_channel_id').value,
            online_emoji: document.getElementById('online_emoji').value,
            offline_emoji: document.getElementById('offline_emoji').value,
            // 保持默认值
            checkin_open: true, checkin_cmd: '/daka', query_open: true, query_cmd: '/online'
        };
        fetch('/api/save_system', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
        .then(()=>alert('设置已保存'));
    }
</script>
{% endblock %}
