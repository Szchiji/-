{% extends "base.html" %}
{% block content %}
<div class="row">
    <!-- 左侧：消息模板 (增强版) -->
    <div class="col-lg-7 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white fw-bold">
                <i class="fa-solid fa-pen-nib me-2 text-primary"></i>消息模板编辑器
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3">
                    <small class="text-muted d-block mb-2 fw-bold">点击插入变量：</small>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 cursor-pointer" onclick="insertTxt('{onlineEmoji}')">{在线状态}</span>
                        {% for f in fields %}
                        <span class="badge bg-secondary bg-opacity-10 text-dark border cursor-pointer" onclick="insertTxt('{'+'{{ f.label }}'+'}')">{{ f.label }}</span>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- 修复：完整的工具栏 -->
                <div class="editor-tb">
                    <button class="editor-btn" onclick="execCmd('bold')" title="加粗"><b>B</b></button>
                    <button class="editor-btn" onclick="execCmd('italic')" title="斜体"><i>I</i></button>
                    <button class="editor-btn" onclick="execCmd('underline')" title="下划线"><u>U</u></button>
                    <button class="editor-btn" onclick="execCmd('strikeThrough')" title="删除线"><s>S</s></button>
                    <div style="width:1px;background:#ddd;margin:0 5px;"></div>
                    <button class="editor-btn" onclick="promptLink()" title="插入链接"><i class="fa-solid fa-link"></i></button>
                </div>
                
                <!-- 编辑区域 -->
                <div id="editor" class="editor-content flex-grow-1" contenteditable="true"></div>
            </div>
        </div>
    </div>
    
    <!-- 右侧：系统参数 (无重复) -->
    <div class="col-lg-5 mb-4">
        <div class="card">
            <div class="card-header bg-white fw-bold">
                <i class="fa-solid fa-sliders me-2 text-primary"></i>系统参数配置
            </div>
            <div class="card-body">
                <h6 class="text-uppercase text-muted small fw-bold mb-3 border-bottom pb-2">互动设置</h6>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="auto_like" {{ 'checked' if sys.auto_like }}>
                    <label class="form-check-label">自动点赞打卡消息</label>
                </div>
                <div class="mb-4">
                    <label class="form-label small">点赞表情 (Emoji)</label>
                    <input id="like_emoji" class="form-control" value="{{ sys.like_emoji }}">
                </div>
                
                <h6 class="text-uppercase text-muted small fw-bold mb-3 border-bottom pb-2">推送配置</h6>
                <div class="mb-4">
                    <label class="form-label small">推送目标频道 ID</label>
                    <input id="push_channel_id" class="form-control" placeholder="-100xxxxxxx" value="{{ sys.push_channel_id }}">
                    <div class="form-text small">请确保机器人已加入该频道并设置为管理员。</div>
                </div>
                
                <h6 class="text-uppercase text-muted small fw-bold mb-3 border-bottom pb-2">状态图标</h6>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label small">在线 Emoji</label>
                        <input id="online_emoji" class="form-control text-center" value="{{ sys.online_emoji }}">
                    </div>
                    <div class="col-6">
                        <label class="form-label small">离线 Emoji</label>
                        <input id="offline_emoji" class="form-control text-center" value="{{ sys.offline_emoji }}">
                    </div>
                </div>

                <button class="btn btn-primary w-100 mt-4 fw-bold" onclick="saveSys()">
                    <i class="fa-solid fa-save me-2"></i>保存所有设置
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // 初始化编辑器内容
    document.getElementById('editor').innerHTML = `{{ template_str|safe }}`;
    
    function saveSys() {
        const data = {
            template: document.getElementById('editor').innerHTML,
            auto_like: document.getElementById('auto_like').checked,
            like_emoji: document.getElementById('like_emoji').value,
            push_channel_id: document.getElementById('push_channel_id').value,
            online_emoji: document.getElementById('online_emoji').value,
            offline_emoji: document.getElementById('offline_emoji').value,
            // 保持打卡指令配置
            checkin_open: true, checkin_cmd: '/daka', query_open: true, query_cmd: '/online'
        };
        fetch('/api/save_system', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
        .then(()=>alert('✅ 系统配置已保存！'));
    }
</script>
{% endblock %}
