{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>认证用户列表</h4>
    <div class="d-flex gap-2">
        <input type="text" class="form-control" placeholder="搜索..." value="{{ q }}" onchange="location.href='?q='+this.value">
        <button class="btn btn-primary" onclick="openModal()">+ 添加</button>
    </div>
</div>

<div class="card">
    <table class="table table-hover align-middle mb-0">
        <thead class="bg-light"><tr><th>TG ID</th><th>预览</th><th>状态</th><th class="text-end">操作</th></tr></thead>
        <tbody>
            {% for u in users %}
            <tr>
                <td>{{ u.tg_id }}</td>
                <td>
                    {% set d = u.profile_data|from_json %}
                    {% for k,v in d.items() %}
                        {% if loop.index <= 4 and v %}<span class="badge bg-light text-dark border me-1">{{ v }}</span>{% endif %}
                    {% endfor %}
                </td>
                <td>{% if u.online %}<span class="badge bg-success">在线</span>{% else %}<span class="badge bg-secondary">离线</span>{% endif %}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-info text-white" onclick="pushUser({{ u.id }})">推送</button>
                    <button class="btn btn-sm btn-outline-primary" onclick='editUser({{ u.tg_id }}, {{ u.profile_data|tojson }})'>编辑</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="delUser({{ u.id }})">删除</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="userModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">用户资料</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="mb-3"><label>TG ID</label><input type="number" name="tg_id" class="form-control" required></div>
                    <div id="modalFields"></div>
                    <hr>
                    <div class="row">
                        <div class="col"><label>加天数</label><input type="number" name="add_days" class="form-control" value="0"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveUser()">保存</button></div>
        </div>
    </div>
</div>

<script>
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    const fields = {{ fields|tojson }};
    
    function renderFields(data) {
        const con = document.getElementById('modalFields');
        con.innerHTML = '';
        fields.forEach(f => {
            let val = data[f.key] || '';
            let html = '';
            if(f.type === 'select') {
                let opts = (f.options||[]).map(o=>`<option value="${o}" ${o==val?'selected':''}>${o}</option>`).join('');
                html = `<select name="${f.key}" class="form-select"><option value="">选一个</option>${opts}</select>`;
            } else if(f.type === 'checkbox') {
                html = '<div>';
                (f.options||[]).forEach(o => {
                    let chk = (val.split(',').includes(o)) ? 'checked' : '';
                    html += `<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" name="${f.key}" value="${o}" ${chk}><label class="form-check-label">${o}</label></div>`;
                });
                html += '</div>';
            } else {
                html = `<input type="text" name="${f.key}" class="form-control" value="${val}">`;
            }
            con.innerHTML += `<div class="mb-3"><label>${f.label}</label>${html}</div>`;
        });
    }

    function openModal() { document.getElementById('userForm').reset(); renderFields({}); modal.show(); }
    function editUser(tgId, data) {
        const form = document.getElementById('userForm');
        form.tg_id.value = tgId;
        renderFields(data);
        modal.show();
    }
    
    function saveUser() {
        const formData = new FormData(document.getElementById('userForm'));
        const data = { tg_id: formData.get('tg_id'), add_days: formData.get('add_days'), profile: {} };
        fields.forEach(f => {
            if(f.type==='checkbox') {
                const vals = [];
                document.querySelectorAll(`input[name="${f.key}"]:checked`).forEach(c => vals.push(c.value));
                data.profile[f.key] = vals.join(',');
            } else {
                data.profile[f.key] = formData.get(f.key);
            }
        });
        fetch('/api/save_user', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}).then(()=>location.reload());
    }
    
    function delUser(id) {
        if(confirm('删除?')) fetch('/api/delete_user', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}).then(()=>location.reload());
    }
    
    function pushUser(id) {
        if(confirm('推送到频道?')) fetch('/api/push_user', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}).then(r=>r.json()).then(d=>alert(d.msg));
    }
</script>
{% endblock %}
