<!DOCTYPE html>
<html>
<head>
    <title>阿宿Bot 面板</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.tinymce.com/4/tinymce.min.js"></script>
    <script>
        tinymce.init({
            selector: 'textarea',
            plugins: 'link image lists',
            toolbar: 'undo redo | styleselect | bold italic underline strikethrough | alignleft aligncenter alignright | bullist numlist outdent indent | link image',
            menubar: 'format insert',
            height: 300
        });
    </script>
    <style>
        .red-tip { color: red; font-weight: bold; }
        .dot-green { color: green; } .dot-red { color: red; }
    </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
    <!-- 侧边栏 -->
    <nav class="main-sidebar sidebar-dark-primary elevation-4">
        <ul class="nav nav-pills nav-sidebar flex-column">
            {% for item in sidebar %}
                <li class="nav-item"><a href="{{ item.url }}" class="nav-link">{{ item.name }}</a></li>
            {% endfor %}
        </ul>
    </nav>

    <!-- 内容区 -->
    <div class="content-wrapper">
        <div class="content">
            <div class="container-fluid">
                <!-- 群组选择下拉 (新添加) -->
                <select onchange="location.href='/?group_id=' + this.value" class="form-control mb-3">
                    <option>选择群组</option>
                    <option value="{{ MAIN_CHAT_ID }}">主群</option>
                    <!-- 动态添加其他群，从 DB 或 Config -->
                </select>
                {% if content == 'index' %}
                    <h1>认证用户列表</h1>
                    <input type="text" id="searchInput" placeholder="搜索..." class="form-control mb-2">
                    <table id="userTable" class="table table-bordered">
                        <thead><tr><th>ID</th><th>培训字幕</th><th>地区</th><th>到期</th><th>操作</th></tr></thead>
                        <tbody>
                            {% for user in users %}
                                <tr><td>{{ user.id }}</td><td>{{ user.training_title }}</td><td>{{ user.region }}</td><td>{{ user.expiration_date or '无限期' }}</td><td><button class="btn-primary">编辑</button> <button class="btn-danger">删除</button></td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <script>
                        $(document).ready(function() {
                            var table = $('#userTable').DataTable({ paging: true, searching: true, ordering: true });
                            $('#searchInput').on('keyup', function() { table.search(this.value).draw(); });
                        });
                    </script>
                {% elif content == 'auth_config' %}
                    <h1>编辑权限字段段</h1>
                    <p class="red-tip">这些字段根据你的需求配置 支持提交实能</p>
                    <table class="table table-bordered">
                        <thead><tr><th>字段名称</th><th>类型</th><th>选项</th><th>操作</th></tr></thead>
                        <tbody>
                            {% for field in fields %}
                                <tr><td>{{ field }}</td><td><select><option>文本</option><option>单选</option><option>多选</option></select></td><td><input placeholder="A,B,C..."></td><td><button class="btn-primary">修改</button> <button class="btn-danger">X</button></td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button class="btn-primary">添加字段</button>
                {% elif content == 'add_user' %}
                    <h1>添加认证用户</h1>
                    <form method="post">
                        <label>Telegram ID:</label> <input name="telegram_id"><br>
                        <label>会员Id:</label> <input name="membership_id"><br>
                        <label>升级:</label> <input name="upgrade_count" value="0"><br>
                        <label>培训字幕:</label> <input name="training_title"><br>
                        <label>培训链接:</label> <input name="training_link"><br>
                        <label>培训通道:</label> <input name="training_channel"><br>
                        <label>等级:</label> <select name="level"><option>A</option><option>B</option><option>E</option></select><br>
                        <label>价格:</label> <input name="price"><br>
                        <label>地区:</label> <input name="region"><br>
                        <label>类型:</label> <input type="checkbox" name="types" value="短视频">短视频 <input type="checkbox" name="types" value="女友属">女友属 ...<br>
                        <label>图片URL:</label> <input name="image_url"><br>
                        <label>到期日期 (YYYY-MM-DD):</label> <input name="expiration_date" type="date"><br>
                        <button type="submit" class="btn-primary">提交</button> <button class="btn-success">保存</button>
                    </form>
                {% elif content == 'auto_reply' %}
                    <h1>自动回复配置</h1>
                    <input type="text" id="searchInput" placeholder="搜索关键词..." class="form-control mb-2">
                    <button class="btn-primary" onclick="location.href='/auto_reply/add'">+ 添加规则</button>
                    <table id="replyTable" class="table table-bordered">
                        <thead><tr><th>ID</th><th>关键词</th><th>回复</th><th>优先级</th><th>状态</th><th>操作</th></tr></thead>
                        <tbody>
                            {% for rule in rules %}
                                <tr><td>{{ rule.id }}</td><td>{{ rule.keyword }}</td><td>{{ rule.reply_text }}</td><td>{{ rule.priority }}</td><td>{{ rule.status }}</td>
                                    <td>
                                        <button class="btn-primary" onclick="toggleEnable({{ rule.id }})">启用/禁用</button>
                                        <button class="btn-success" onclick="previewReply({{ rule.id }})">预览</button>
                                        <button class="btn-info" onclick="exportLog({{ rule.id }})">导出日志</button>
                                        <button class="btn-danger">删除</button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <h2>回复日志</h2>
                    <table id="logTable" class="table table-bordered">
                        <thead><tr><th>ID</th><th>规则ID</th><th>用户ID</th><th>时间</th><th>次数</th></tr></thead>
                        <tbody>
                            {% for log in logs %}
                                <tr><td>{{ log.id }}</td><td>{{ log.rule_id }}</td><td>{{ log.user_id }}</td><td>{{ log.timestamp }}</td><td>{{ log.count }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <script>
                        $(document).ready(function() {
                            var table = $('#replyTable').DataTable({ paging: true, searching: true, ordering: true });
                            $('#searchInput').on('keyup', function() { table.search(this.value).draw(); });
                        });
                        function toggleEnable(ruleId) {
                            $.post('/auto_reply/toggle/' + ruleId, function(data) { alert('状态: ' + data.status); location.reload(); });
                        }
                        function previewReply(ruleId) {
                            $.get('/auto_reply/preview/' + ruleId, function(data) { alert(data.preview); });
                        }
                        function exportLog(ruleId) {
                            window.location.href = '/auto_reply/export/' + ruleId;
                        }
                    </script>
                {% elif content == 'scheduled' %}
                    <h1>定时发送配置</h1>
                    <input type="text" id="searchInput" placeholder="Q 搜索群组/链接..." class="form-control mb-2">
                    <button class="btn-primary" onclick="location.href='/scheduled/add'">+ 添加定时发送</button>
                    <table id="scheduledTable" class="table table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>群组</th>
                                <th>上次发送</th>
                                <th>链接</th>
                                <th>下次发送</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                                <tr>
                                    <td>TS{{ task.id }}</td>
                                    <td>{{ task.chat_id }}</td>
                                    <td>{{ task.last_sent.strftime('%Y-%m-%d %H:%M') if task.last_sent else '-' }}</td>
                                    <td><a href="{{ task.media_url or task.link }}">{{ task.media_url or task.link or '-' }}</a></td>
                                    <td>{{ task.next_sent.strftime('%Y-%m-%d %H:%M') if task.next_sent else '-' }}</td>
                                    <td>{{ task.execution_count or 0 }}</td>
                                    <td><button class="btn-primary">修改</button> <button class="btn-danger">删除</button></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <script>
                        $(document).ready(function() {
                            var table = $('#scheduledTable').DataTable({ paging: true, searching: true, ordering: true, language: { paginate: { next: '>', previous: '<' } } });
                            $('#searchInput').on('keyup', function() { table.search(this.value).draw(); });
                        });
                    </script>
                {% elif content == 'force_subscribe' %}
                    <h1>强制订阅配置</h1>
                    <form action="/force_subscribe/update_settings" method="post">
                        <label>启用自动解除:</label> <input type="checkbox" name="auto_unmute_enabled" {% if auto_unmute == 'True' %}checked{% endif %} value="True"><br>
                        <label>解除消息:</label> <textarea name="unmute_message">{{ unmute_message }}</textarea><br>
                        <button type="submit">保存</button>
                    </form>
                    <table id="forceTable" class="table table-bordered">
                        <!-- 列和数据从之前 -->
                    </table>
                {% elif content == 'points_config' %}
                    <h1>积分系统配置</h1>
                    <form action="/points/add_item" method="post">
                        <label>商品名:</label> <input name="name"><br>
                        <label>成本积分:</label> <input name="cost" type="number"><br>
                        <label>描述:</label> <textarea name="description"></textarea><br>
                        <label>库存:</label> <input name="stock" type="number" value="10"><br>
                        <button type="submit">添加商品</button>
                    </form>
                    <table id="itemTable" class="table table-bordered">
                        <thead><tr><th>ID</th><th>商品名</th><th>成本</th><th>描述</th><th>库存</th><th>操作</th></tr></thead>
                        <tbody>
                            {% for item in items %}
                                <tr><td>{{ item.id }}</td><td>{{ item.name }}</td><td>{{ item.cost }}</td><td>{{ item.description }}</td><td>{{ item.stock }}</td><td><!-- 操作 --></td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- DataTables -->
                {% endif %}
            </div>
        </div>
    </div>
</div>
</body>
</html>
